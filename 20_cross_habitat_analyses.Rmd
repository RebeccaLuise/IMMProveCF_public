---
title: "Cross-habitat microbial colonization structure in pwCF (gut-respiratory vs lung-throat axis)"
author: "Rebecca L. Knoll"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Outline
- Procrustes
- Mantel test (not included in manuscript)
- Co-correlation analyses (not included in manuscript)
- Venn diagram of shared ASVs (not included in manuscript)
- Ordination on generalist vs specialist taxa across habitats (not included in manuscript)
- Distance dissimilarities between paired and unpaired samples
- Congruence of alpha diversity metrics between sample types
- Shared ASVs between sampling types
- PERMANOVA: variance explained by sampling type vs time point of sampling

# Load libraries and data sets and select paired samples and filter phyloseq
```{r run import script, include=FALSE}
# run script to tidy the data and to load packages, creates phyloseq object per material and per year; load libraries

ps_sputum_full <- readRDS("/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/ps_IMProveCF_patients_Run1-23_18102023.rds")

ps_full <- readRDS("/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/ps_IMProveCF_patientsAndControls_Run1-23_18102023.rds")

pacman::p_load(rmarkdown, tidyverse, phyloseq, magrittr, janitor, microbiome, knitr, lubridate, naniar, readxl, ggplot2, ggpubr, vegan)

metadata <- as(sample_data(ps_full), "data.frame")

metadata_v1 <- metadata %>% 
   filter(project=="IMMPIMMP") %>% 
  filter(visit==1)

source("/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/IMMProveCF/functions_sputhr.R")
```

```{r subset per sample type, include=FALSE}
material_s_t <- c("Sputum", "Stool")

ps_Sputum_Stool_full <- subset_samples(ps_sputum_full, material %in% material_s_t)

ps_sputum_full_sputum <- subset_samples(ps_sputum_full, material== "Sputum")

id_visit_sputum <- sample_data(ps_sputum_full_sputum)$id_visit

ps_Sputum_Stool_full_unique <- subset_samples(ps_sputum_full, id_visit %in% id_visit_sputum)#includes also stool samples
ps_Sputum_Stool_full_unique <- subset_samples(ps_Sputum_Stool_full_unique, material %in% material_s_t)#includes still sputum samples which do not have a paired stool sample

# find those stool samples which have a paired sputum sample
ps_sputum_full_stool <- subset_samples(ps_sputum_full, material== "Stool")
ps_Sputum_Stool_full_unique_3 <- subset_samples(ps_sputum_full_stool, id_visit %in% id_visit_sputum)#includes also stool samples
id_visit_unique <- sample_data(ps_Sputum_Stool_full_unique_3)$id_visit

#filter for only those samples which have both sputum and stool from the same timepoint
ps_Sputum_Stool_full_unique_2 <- subset_samples(ps_Sputum_Stool_full_unique, id_visit %in% id_visit_unique)#includes still sputum samples which do not have a paired stool sample

summary(sample_data(ps_Sputum_Stool_full_unique_2)$id) # 15 participants provided both sputum & stool samples at the same timepoint

data <- as(sample_data(ps_Sputum_Stool_full_unique_2), "data.frame")

tabyl(data, id, visit_cal_cor)

#transform to relative abundance
ps_Sputum_Stool_full_unique_2_relab <- transform_sample_counts(ps_Sputum_Stool_full_unique_2 , function(x) x/sum(x))
```

# Sputum vs. stool microbiome
## Sample overview
```{r}
# plot sample overview
bp_ps_relab <- plot_bar(ps_Sputum_Stool_full_unique_2_relab, "id", fill="Phylum")

bp_ps_relab+
  geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack")+
    theme(legend.key.height= unit(3, 'mm'),
        legend.key.width= unit(3, 'mm'),legend.text = element_text(size=8), legend.position = "bottom", 
        axis.ticks = element_blank(), axis.text.x = element_blank())+
  scale_x_discrete(name="Participant")+
  scale_y_continuous(name="Relative abundance")+
  facet_grid(rows= vars(material), cols = vars(visit_cal_cor), scales ="free_x", space ="free_x")
```

# Procrustes 
## Goal
Use Orthogonal Procrustes Analysis (OPA) to assess how similar the overall spatial configuration (beta diversity structure) is between:

    Sputum vs. Gut
    Throat vs. Sputum

OPA will rotate, translate, and scale one ordination to best match another and quantify similarity with a Procrustes statistic (m²).

## Interpretation

    Procrustes statistic (m²): Lower means better alignment.
    protest(): Gives a p-value testing if the alignment is better than expected by chance (random configuration).
    If the alignment is significant and tight, it supports the idea that there is a shared ecological structure, aka a gut-lung or airway continuum.

## Sputum vs Stool    
```{r}
sputum_common  <- subset_samples(ps_Sputum_Stool_full_unique_2_relab, material=="Sputum")
gut_common<- subset_samples(ps_Sputum_Stool_full_unique_2_relab, material=="Stool")

# Create distance matrices (Bray-Curtis)
gut_dist <- phyloseq::distance(gut_common, method = "bray")
sputum_dist <- phyloseq::distance(sputum_common, method = "bray")

# Ordinate using PCoA (or use NMDS if you'd rather)
gut_ord <- ordinate(gut_common, method = "PCoA", distance = gut_dist)
sputum_ord <- ordinate(sputum_common, method = "PCoA", distance = sputum_dist)

# Grab the first few axes (same number)
gut_coords  <- cmdscale(gut_dist, k = 10)
sputum_coords <- cmdscale(sputum_dist, k = 10)

# Run Procrustes analysis
proc <- procrustes(gut_coords, sputum_coords)

# Summary
summary(proc)

# Significance test
proc_test_paired <- protest(gut_coords, sputum_coords, permutations = 999)
print(proc_test_paired)

# Visualization
plot(proc)
```

### unpaired data set comparison
```{r}
 set.seed(42)

# Get number of paired samples
n_pairs <- nsamples(ps_Sputum_Stool_full_unique_2_relab) / 2

ps_Sputum_Stool_full_relab <- transform_sample_counts(ps_Sputum_Stool_full, function(x) x/sum(x))

# Split ps_Sputum_Stool_full by sample type
sample_data_df <- as.data.frame(sample_data(ps_Sputum_Stool_full_relab))
gut_samples <- rownames(sample_data_df[sample_data_df$material == "Stool", ])
sputum_samples <- rownames(sample_data_df[sample_data_df$material == "Sputum", ])

# Extract IDs used in the paired dataset
paired_ids <- unique(sample_data(ps_Sputum_Stool_full_unique_2_relab)$id.x)
# Select unpaired gut (Stool) samples only (those with IDs not in the paired set)
gut_samples <- rownames(sample_data_df[
  sample_data_df$material == "Stool" & !(sample_data_df$id.x %in% paired_ids),
])

# Initialize vector to store Procrustes stats (m12)
m12_values <- numeric(1000)

# Subsampling loop
for (i in 1:1000) {
  sampled_gut <- sample(gut_samples, n_pairs)
  sampled_sputum <- sample(sputum_samples, n_pairs)

  # Prune to the subsampled data
  gut_sub <- prune_samples(sampled_gut, ps_Sputum_Stool_full_relab)
  sputum_sub <- prune_samples(sampled_sputum, ps_Sputum_Stool_full_relab)

  # Calculate Bray-Curtis distances
  gut_dist <- distance(gut_sub, method = "bray")
  sputum_dist <- distance(sputum_sub, method = "bray")

  # Perform PCoA
  gut_coords <- cmdscale(gut_dist, k = 10)
  sputum_coords <- cmdscale(sputum_dist, k = 10)

  # Run Procrustes
  proc_test <- protest(gut_coords, sputum_coords, permutations = 999)
  m12_values[i] <- proc_test$ss  # or use sqrt(proc$ss) depending on your summary preference

}

# Paired result
paired_proc_stat_gut <- proc_test_paired$ss  

m12_values
# Plot histogram
m12_df <- data.frame(m12 = m12_values)

p14 <- ggplot(m12_df, aes(x = m12)) +
  geom_histogram(bins = 50, fill = "#765085", color = "white", alpha=0.4) +
  geom_vline(xintercept = paired_proc_stat_gut, color = "#31A1B3", size = 1.2) +
  labs(
   title = "Sputum-Stool",
    x = "Procrustes sum of squares",
    y = "Count"
  ) +
  theme_minimal(base_size = 14) +
  theme(title = element_text(size=14) )+
   annotate("text", x = 0.8455, y = 70, label = "ns", size = 5)

p14
saveRDS(p14, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/procrustes_spu_stool.rds")
```

## Sputum vs Throat
```{r}
# Subset your phyloseq objects to overlapping samples
material_s_t <- c("Sputum", "Throat")

ps_sputum_throat_full <- subset_samples(ps_sputum_full, material %in% material_s_t)

ps_sputum_full_sputum <- subset_samples(ps_sputum_full, material== "Sputum")

id_visit_sputum <- sample_data(ps_sputum_full_sputum)$id_visit

ps_sputum_throat_full_unique <- subset_samples(ps_sputum_full, id_visit %in% id_visit_sputum)#includes also stool samples
ps_sputum_throat_full_unique <- subset_samples(ps_sputum_throat_full_unique, material %in% material_s_t)#includes still sputum samples which do not have a paired throat sample

# find those throat samples which have a paired sputum sample
ps_sputum_full_throat <- subset_samples(ps_sputum_full, material== "Throat")
ps_sputum_throat_full_unique_3 <- subset_samples(ps_sputum_full_throat, id_visit %in% id_visit_sputum)#includes also stool samples
id_visit_unique <- sample_data(ps_sputum_throat_full_unique_3)$id_visit

#filter for only those samples which have both sputum and throat from the same timepoint
ps_sputum_throat_full_unique_2 <- subset_samples(ps_sputum_throat_full_unique, id_visit %in% id_visit_unique)#includes still sputum samples which do not have a paired throat sample

summary(sample_data(ps_sputum_throat_full_unique_2)$id) # 15 participants provided both sputum & throat samples at the same timepoint

data <- as(sample_data(ps_sputum_throat_full_unique_2), "data.frame")

tabyl(data, id, visit_cal_cor)

#transform to relative abundance
ps_sputum_throat_full_unique_2_relab <- transform_sample_counts(ps_sputum_throat_full_unique_2 , function(x) x/sum(x))
```

### Sample overview
```{r}
# plot sample overview
bp_ps_relab <- plot_bar(ps_sputum_throat_full_unique_2_relab, "id", fill="Phylum")

bp_ps_relab+
  geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack")+
    theme(legend.key.height= unit(3, 'mm'),
        legend.key.width= unit(3, 'mm'),legend.text = element_text(size=8), legend.position = "bottom", 
        axis.ticks = element_blank(), axis.text.x = element_blank())+
  scale_x_discrete(name="Participant")+
  scale_y_continuous(name="Relative abundance")+
  facet_grid(rows= vars(material), cols = vars(visit_cal_cor), scales ="free_x", space ="free_x")
```

```{r}
 set.seed(42)
sputum_common  <- subset_samples(ps_sputum_throat_full_unique_2_relab, material=="Sputum")
throat_common<- subset_samples(ps_sputum_throat_full_unique_2_relab, material=="Throat")

# Create distance matrices (e.g., Bray-Curtis)
throat_dist <- phyloseq::distance(throat_common, method = "bray")
sputum_dist <- phyloseq::distance(sputum_common, method = "bray")

# Grab the first few axes (same number)
throat_coords  <- cmdscale(throat_dist, k=10)
sputum_coords <- cmdscale(sputum_dist, k=10)

# Run Procrustes analysis
proc_resp <- procrustes(throat_coords, sputum_coords)

# Summary
summary(proc_resp)

# Significance test
proc_test_paired_resp <- protest(throat_coords, sputum_coords, permutations = 999)
print(proc_test_paired_resp)

# Visualization
plot(proc_resp)

```

### unpaired data set comparison
```{r}
 set.seed(42)

# Get number of paired samples
n_pairs <- nsamples(ps_sputum_throat_full_unique_2_relab) / 2

# Split ps_Sputum_Throat_full by sample type
sample_data_df <- as.data.frame(sample_data(ps_sputum_throat_full))
sputum_samples <- rownames(sample_data_df[sample_data_df$material == "Sputum", ])

# Extract IDs used in the paired dataset
paired_ids <- unique(sample_data(ps_sputum_throat_full_unique_2_relab)$id.x)
# Select unpaired throat (Throat) samples only (those with IDs not in the paired set)
throat_samples <- rownames(sample_data_df[sample_data_df$material == "Throat" & !(sample_data_df$id.x %in% paired_ids),
])

# Initialize vector to store Procrustes stats (m12)
m12_values <- numeric(1000)

# calculate rel. abundance
ps_sputum_throat_full_relab <- transform_sample_counts(ps_sputum_throat_full, function(x) x/sum(x))

# Subsampling loop
for (i in 1:1000) {
  sampled_throat <- sample(throat_samples, n_pairs)
  sampled_sputum <- sample(sputum_samples, n_pairs)

  # Prune to the subsampled data
  throat_sub <- prune_samples(sampled_throat, ps_sputum_throat_full_relab)
  sputum_sub <- prune_samples(sampled_sputum, ps_sputum_throat_full_relab)

  # Calculate Bray-Curtis distances
  throat_dist <- distance(throat_sub, method = "bray")
  sputum_dist <- distance(sputum_sub, method = "bray")

  # Perform PCoA
  throat_coords <- cmdscale(throat_dist, k = 10)
  sputum_coords <- cmdscale(sputum_dist, k = 10)

  # Run Procrustes
  proc_test_resp <- protest(throat_coords, sputum_coords, permutations = 999)
  m12_values[i] <- proc_test_resp$ss  # or use sqrt(proc$ss) depending on your summary preference

}

# Paired result
paired_proc_stat <- proc_test_paired_resp$ss  

# Plot histogram
m12_df_resp <- data.frame(m12 = m12_values)


p13 <- ggplot(m12_df_resp, aes(x = m12)) +
  geom_histogram(bins = 50, fill = "#765085", color = "white", alpha=0.4) +
  geom_vline(xintercept = paired_proc_stat, color = "#31A1B3", size = 1.2) +
  labs(
    title = "Sputum-Throat",
    x = "Procrustes sum of squares",
    y = "Count"
  ) +
  theme_minimal(base_size = 14) +
  theme(title = element_text(size=14) )+
   annotate("text", x = 0.82, y = 60, label = "*", size = 8)
p13
saveRDS(p13, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/procrustes_spu_throat.rds")
```

```{r, fig.height=3, fig.width=8}
ggarrange(p13,p14, nrow = 1)

ggsave("figures/procrustes_paired_unpaired_comb.pdf", height = 3, width = 8)
```

## Conclusion:

Quick interpretation of Procrustes protest results:
Comparison	Sum of Squares	Correlation (r)	p-value	Interpretation
Throat vs Sputum	0.8172	0.4275	0.042	Significant alignment (p < 0.05) → evidence for similarity
Gut vs Sputum	0.8424	0.3970	0.103	Not significant (p > 0.05) → weaker or noisier alignment
Biological read:

→ The throat microbiome is significantly more similar to sputum than the gut microbiome is.
→ This is biologically intuitive: the throat and sputum (lung) are physically closer, and microbial exchange is plausible (aspiration, mucus flow).

Gut-lung interactions are more complex — maybe indirect, systemic (immune-mediated), or only affecting specific taxa.

# Mantel test:
```{r}
sputum_common  <- subset_samples(ps_Sputum_Stool_full_unique_2_relab, material=="Sputum")
gut_common<- subset_samples(ps_Sputum_Stool_full_unique_2_relab, material=="Stool")
# Create distance matrices (e.g., Bray-Curtis)
gut_dist <- phyloseq::distance(gut_common, method = "bray")
sputum_dist <- phyloseq::distance(sputum_common, method = "bray")

mantel(gut_dist, sputum_dist, permutations = 999)

sputum_common  <- subset_samples(ps_sputum_throat_full_unique_2_relab, material=="Sputum")
throat_common<- subset_samples(ps_sputum_throat_full_unique_2_relab, material=="Throat")

# Create distance matrices (e.g., Bray-Curtis)
throat_dist <- phyloseq::distance(throat_common, method = "bray")
sputum_dist <- phyloseq::distance(sputum_common, method = "bray")

mantel(throat_dist, sputum_dist, permutations = 999)
```
## Interpretaion of mantel test: 
→ Mantel r is a correlation between the structure of distance matrices — so:

    "Do samples that are similar in gut also tend to be similar in sputum?"

→ Here, both r values are very small (~0.07 - 0.10), meaning:

    There's only a very weak correspondence between the community structure of gut vs. sputum or throat vs. sputum.

→ p-values ~0.10 → not formally significant, but some weak trend.

# Co-correlation analysis
## Sputum vs. throat
```{r}
library(purrr)
library(MicEco)

ps_venn(ps_sputum_throat_full_unique_2_relab, group = "material")
list <- ps_venn(ps_sputum_throat_full_unique_2_relab, group = "material", plot = F)

# subset phyloseq for the shared ASVs
ps_shared <- prune_taxa(taxa_names(ps_sputum_throat_full_unique_2_relab) %in% list$Sputum__Throat, ps_sputum_throat_full_unique_2_relab)

# select taxa that are present in at least 2 pairs
# 1. Convert to long format
abund_df <- psmelt(ps_shared)

# 2. Filter out 0-abundance
abund_df <- abund_df %>% filter(Abundance > 0)

# 3. Count number of *matched pairs* per taxon
paired_taxa <- abund_df %>%
  select(OTU, id_visit, material) %>%
  distinct() %>%
  group_by(OTU, id_visit) %>%
  summarise(n_material = n(), .groups = "drop") %>%
  filter(n_material == 2) %>%  # Present in both sites
  count(OTU, name = "n_pairs") %>%
  filter(n_pairs >= 2)      # At least 2 such pairs

# 4. Filter phyloseq object to keep only these taxa
ps_shared_fil <- prune_taxa(paired_taxa$OTU, ps_shared)


sputum_common  <- subset_samples(ps_shared_fil, material=="Sputum")
throat_common<- subset_samples(ps_shared_fil, material=="Throat")

# Get abundance matrices
otu_throat <- as(otu_table(throat_common), "matrix")
otu_sputum <- as(otu_table(sputum_common), "matrix")

# Get all ASV combinations (cross-product)
asv_combos <- expand.grid(
  throat_asv = colnames(otu_throat),
  sputum_asv = colnames(otu_sputum),
  stringsAsFactors = FALSE
)

# Compute correlations
results <- pmap_dfr(asv_combos, function(throat_asv, sputum_asv) {
  throat_vec <- otu_throat[, throat_asv]
  sputum_vec <- otu_sputum[, sputum_asv]
  
  valid <- complete.cases(throat_vec, sputum_vec)
  
   non_zero_pairs <- throat_vec[valid] > 0 & sputum_vec[valid] > 0
  
  tibble(
    throat_asv = throat_asv,
    sputum_asv = sputum_asv,
    spearman_rho = if (sum(non_zero_pairs) >= 5) {
      cor(throat_vec[valid], sputum_vec[valid], method = "spearman")
    } else {
      NA_real_
    }
  )
})

# Pivot to wide format
corr_mat <- results%>% 
  pivot_wider(
    names_from = sputum_asv, 
    values_from = spearman_rho
  ) %>% 
  column_to_rownames("throat_asv") %>% 
  as.matrix()

view(corr_mat)

# Now you can plot it
corrplot::corrplot(corr_mat, method = "color", 
                   tl.cex = 0.6, 
                   na.label = " ", 
                   col = colorRampPalette(c("blue", "white", "red"))(200))
```


```{r}
# Add correlation to relative abundances
df <- psmelt(ps_shared)

sputum_df <- df %>% filter(material == "Sputum") %>%
  select(x_sample_id, sputum_asv = OTU, sputum_abund = Abundance, id_visit, Genus, id.x, visit_sum)

throat_df <- df %>% filter(material == "Throat") %>%
  select(x_sample_id, throat_asv = OTU, throat_abund = Abundance, id_visit, Genus, id.x, visit_sum)

# Merge by id_visit
merged_df <- inner_join(throat_df, sputum_df, by = "id_visit")

final_df <- left_join(merged_df, results, by = c("throat_asv", "sputum_asv"))

ggplot(final_df, aes(x = throat_abund, y = sputum_abund, color = spearman_rho)) +
  geom_point(alpha = 0.7) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  labs(x = "Throat abundance", y = "Sputum abundance", color = "Spearman rho") +
  theme_classic()+
  scale_y_log10()+
  scale_x_log10()

final_df %>% 
  filter(!is.na(spearman_rho)) %>% 
  filter(abs(spearman_rho)> 0.5) %>% 
  ggplot(aes(x = sputum_abund, y = throat_abund, color = spearman_rho)) + 
  geom_point(alpha = 1, size = 1) + 
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  labs(
    title = "Abundance vs Correlation of Shared ASVs Between Body Sites",
    x = "Sputum Abundance",
    y = "Throat Abundance",
    color = "Spearman Correlation"
  ) +
  theme_minimal()+
  scale_x_log10()+
  scale_y_log10()

library(ggplot2)
library(viridis)  # if not installed: install.packages("viridis")

final_df %>% 
  filter(id_visit == id_visit) %>% 
  filter(throat_asv == sputum_asv) %>% 
  filter(!is.na(spearman_rho)) %>% 
  filter(abs(spearman_rho) > 0.25) %>%
  count(sputum_asv, Genus.x)

genus_colors <- c(
  Alloprevotella = "#BFD8B8",       # soft sage
  Atopobium = "#D4C1EC",            # pastel lavender
  Bergeyella = "#F2C6DE",    # soft rose
  Campylobacter = "#D6E3C4",        # sage-tinted cream
  Catonella = "#FFF3C2",     # soft lemon cream
  Centipeda = "#E2CAD8",            # dusty pink
  Haemophilus = "#D1C87C",          # muted golden sage
  Lactobacillus = "#C9E4C5",        # light moss green
  Lautropia = "#FFE1C6",     # apricot pastel
  Oribacterium = "#C6CEA1",  # sage green
  Prevotella = "#A4D4C3",           # soft seafoam
  Prevotella_7 = "#B2BC82",  # warm dusty rose
  Shuttleworthia = "#C2C9A6",       # sage olive
  Solobacterium = "#BFD8B8", # pastel sage (same as Alloprevotella for visual harmony)
  `[Eubacterium] brachy group` = "#D7BDE2" # lavender blush
)

log_breaks <- c(1e-4, 1e-3, 1e-2, 1e-1)

log_labels <- c("0%", "0.1%", "1%", "10%")

final_df <- final_df %>%
  mutate(
    rho_size = case_when(
      spearman_rho <= -0.4 ~ 1,
      spearman_rho <= -0.3 ~ 2,
      spearman_rho >= 0.3 & spearman_rho < 0.4 ~ 4,
      spearman_rho >= 0.4 ~ 5
    )
  )

size_labels <- c(
  "1" = "≤ -0.4",
  "2" = "-0.4 to -0.3",
  "4" = "0.3 to 0.4",
  "5" = "≥ 0.4"
)

p10 <- final_df %>% 
  filter(id_visit == id_visit) %>%
  filter(throat_asv == sputum_asv) %>% 
  filter(!is.na(spearman_rho)) %>% 
  filter(abs(spearman_rho) > 0.25) %>%
  mutate(
    throat_abund = throat_abund + 1e-4,
    sputum_abund = sputum_abund + 1e-4,
    rho_sign = ifelse(spearman_rho > 0, "positive", "negative")
  ) %>%
  ggplot(aes(x = throat_abund, y = sputum_abund, fill = Genus.x, color=Genus.x, shape = rho_sign)) +
  geom_point(alpha = 1, size = 4) +
  scale_color_manual(values = genus_colors) +
  scale_fill_manual(values = genus_colors) +
  scale_shape_manual(values = c("positive" = 24, "negative" = 25)) +  # 24 = triangle up, 25 = triangle down
  scale_x_log10(breaks = log_breaks, labels = log_labels) +
  scale_y_log10(breaks = log_breaks, labels = log_labels) +
  labs(
    x = "Throat rel. abundance (%)",
    y = "Sputum rel. abundance (%)",
    color = "Genus",
    shape = "Spearman correlation"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    panel.grid.minor = element_blank(),
    legend.text = element_text(face = "italic")
  ) +
  guides(color = guide_legend(override.aes = list(size = 4)), fill = "none")


p10
saveRDS(p10, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/correlation_spu_thr.rds")

  
```

# plot Sputum/Throat congruence for Staphylococcus/Pseudomonas
```{r}

p15 <- final_df %>% 
  filter(id_visit==id_visit) %>% 
  filter(throat_asv==sputum_asv) %>% 
  filter(throat_asv=="ASV1" | throat_asv=="ASV7") %>% 
  mutate(
    throat_abund = throat_abund * 100 + 1e-3,
    sputum_abund = sputum_abund * 100 + 1e-3
  ) %>%
  ggplot(aes(y = sputum_abund, x = throat_abund, color = Genus.x)) +
  geom_point(alpha = 0.8, size = 4) +
  scale_color_manual(values = c(Pseudomonas = "#fa80ad", Staphylococcus = "#f7a35c")) +
  scale_size(range = c(2, 6)) +
  scale_x_log10(
   breaks = c(1e-3, 1e-2, 1e-1, 1, 10, 100),
  labels = c("0%", "0.01%", "0.1%", "1%", "10%", "100%")
  ) +
  scale_y_log10(
    breaks = c(1e-3, 1e-2, 1e-1, 1, 10, 100),
    labels = c("0%", "0.01%", "0.1%", "1%", "10%", "100%")
  ) +
  labs(
    x = "Throat rel. abundance (%)",
    y = "Sputum rel. abundance (%)",
    color = "Genus"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    panel.grid.minor = element_blank(),
    legend.text = element_text(face = "italic")
  ) +
  guides(
    size = guide_legend(nrow = 1, title = "Spearman rho"),
    color = guide_legend(override.aes = list(size = 4))
  ) +
  geom_smooth(method = "lm", se = FALSE)
p15

saveRDS(p15, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/correlation_staph_pseudo_spu_thr.rds")
```

# Sputum vs. Stool
```{r}
ps_venn(ps_Sputum_Stool_full_unique_2_relab, group = "material")
list <- ps_venn(ps_Sputum_Stool_full_unique_2_relab, group = "material", plot = F)

# subset phyloseq for the shared ASVs
ps_shared <- prune_taxa(taxa_names(ps_Sputum_Stool_full_unique_2_relab) %in% list$Sputum__Stool, ps_Sputum_Stool_full_unique_2_relab)

# select taxa that are present in at least 2 pairs
# 1. Convert to long format
abund_df <- psmelt(ps_shared)

# 2. Filter out 0-abundance
abund_df <- abund_df %>% filter(Abundance > 0)

# 3. Count number of *matched pairs* per taxon
paired_taxa <- abund_df %>%
  select(OTU, id_visit, material) %>%
  distinct() %>%
  group_by(OTU, id_visit) %>%
  summarise(n_material = n(), .groups = "drop") %>%
  filter(n_material == 2) %>%  # Present in both sites
  count(OTU, name = "n_pairs") %>%
  filter(n_pairs >= 2)      # At least 2 such pairs

# 4. Filter phyloseq object to keep only these taxa
ps_shared_fil <- prune_taxa(paired_taxa$OTU, ps_shared)

sputum_common  <- subset_samples(ps_shared_fil, material=="Sputum")
stool_common<- subset_samples(ps_shared_fil, material=="Stool")

# Get abundance matrices
otu_stool <- as(otu_table(stool_common), "matrix")
otu_sputum <- as(otu_table(sputum_common), "matrix")

# Get all ASV combinations (cross-product)
asv_combos <- expand.grid(
  stool_asv = colnames(otu_stool),
  sputum_asv = colnames(otu_sputum),
  stringsAsFactors = FALSE
)

# Compute correlations
results <- pmap_dfr(asv_combos, function(stool_asv, sputum_asv) {
  stool_vec <- otu_stool[, stool_asv]
  sputum_vec <- otu_sputum[, sputum_asv]
  
  valid <- complete.cases(stool_vec, sputum_vec)
  non_zero_pairs <- stool_vec[valid] > 0 & sputum_vec[valid] > 0
  
  tibble(
    stool_asv = stool_asv,
    sputum_asv = sputum_asv,
    spearman_rho = if (sum(non_zero_pairs) >= 5) {
      cor(stool_vec[valid], sputum_vec[valid], method = "spearman")
    } else {
      NA_real_
    }
  )
})

results%>% 
  filter(abs(spearman_rho)>0.35)

# Pivot to wide format
corr_mat <- results%>% 
  filter(!is.na(spearman_rho)) %>% 
  pivot_wider(
    names_from = sputum_asv, 
    values_from = spearman_rho
  ) %>% 
  column_to_rownames("stool_asv") %>% 
  as.matrix()

view(corr_mat)

# Now you can plot it
corrplot::corrplot(corr_mat, method = "color", 
                   tl.cex = 0.6, 
                   na.label = " ", 
                   col = colorRampPalette(c("blue", "white", "red"))(200))

corr_mat_high <- results%>% 
  filter(abs(spearman_rho)>0.35)%>% 
  pivot_wider(
    names_from = sputum_asv, 
    values_from = spearman_rho
  ) %>% 
  column_to_rownames("stool_asv") %>% 
  as.matrix()
corrplot::corrplot(corr_mat_high, method = "color", 
                   tl.cex = 0.6, 
                   na.label = " ", 
                   col = colorRampPalette(c("blue", "white", "red"))(200))
```


```{r}
# Add correlation to relative abundances
df <- psmelt(ps_shared)

sputum_df <- df %>% filter(material == "Sputum") %>%
  select(sputum_sample=x_sample_id, sputum_asv = OTU, sputum_abund = Abundance, sputum_id_visit=id_visit, sputum_genus= Genus)

stool_df <- df %>% filter(material == "Stool") %>%
  select(stool_sample=x_sample_id, stool_asv = OTU, stool_abund = Abundance, stool_id_visit =id_visit, stool_Genus = Genus)

# Merge by id_visit
merged_df <- inner_join(stool_df, sputum_df, by = c("stool_id_visit"="sputum_id_visit"))

final_df <- left_join(merged_df, results, by = c("stool_asv", "sputum_asv"))

ggplot(final_df, aes(x = stool_abund, y = sputum_abund, color = spearman_rho)) +
  geom_point(alpha = 0.7) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  labs(x = "stool abundance", y = "Sputum abundance", color = "Spearman rho") +
  theme_classic()+
  scale_y_log10()+
  scale_x_log10()

final_df %>% 
  filter(!is.na(spearman_rho)) %>% 
  filter(abs(spearman_rho)> 0.5) %>% 
  ggplot(aes(x = sputum_abund, y = stool_abund, color = spearman_rho)) + 
  geom_point(alpha = 1, size = 1) + 
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  labs(
    title = "Abundance vs Correlation of Shared ASVs Between Body Sites",
    x = "Sputum Abundance",
    y = "stool Abundance",
    color = "Spearman Correlation"
  ) +
  theme_minimal()+
  scale_x_log10()+
  scale_y_log10()

library(ggplot2)
library(viridis)  # if not installed: install.packages("viridis")

final_df %>% 
  #filter(stool_id_visit == sputum_id_visit) %>% 
  filter(stool_asv == sputum_asv) %>% 
  filter(!is.na(spearman_rho)) %>% 
  filter(abs(spearman_rho) > 0.25) %>%
  count(stool_Genus, stool_asv)

genus_colors_new <- c(
  Actinomyces = "#8175AA" ,
  ASV5_Bacteroides = "#A68A7B",         
  ASV82_Haemophilus = "#CCB22BFF",          
  Lachnoanaerobaculum = "#94D0C0FF",   
  Scardovia = "#D4A6C8",            
  Streptococcus = "#69b3a2",         
  ASV62_Veillonella="#EEB22BFF",
  ASV20_Veillonella="#D4A6C8"
)

log_breaks <- c(1e-4, 1e-3, 1e-2, 1e-1)

log_labels <- c("0%", "0.1%", "1%", "10%")

final_df <- final_df %>%
  mutate(
    rho_size = case_when(
      spearman_rho <= -0.4 ~ 1,
      spearman_rho <= -0.3 ~ 2,
      spearman_rho >= 0.3 & spearman_rho < 0.4 ~ 4,
      spearman_rho >= 0.4 ~ 5
    )
  )

size_labels <- c(
  "1" = "≤ -0.4",
  "2" = "-0.4 to -0.3",
  "4" = "0.3 to 0.4",
  "5" = "≥ 0.4"
)

final_df %>% filter(abs(spearman_rho) > 0.25) %>% filter(stool_asv == sputum_asv) %>% count(stool_asv)

final_df %>% filter(abs(spearman_rho) > 0.25) %>% filter(stool_asv == sputum_asv) %>% filter(stool_Genus=="Streptococcus") %>% select(stool_asv, stool_abund, sputum_asv, sputum_abund, spearman_rho )

p11 <- final_df %>% 
  filter(stool_asv == sputum_asv) %>% 
  filter(!is.na(spearman_rho)) %>% 
  filter(abs(spearman_rho) > 0.25) %>%
  mutate(
    stool_abund = stool_abund + 1e-4,
    sputum_abund = sputum_abund + 1e-4,
    rho_sign = ifelse(spearman_rho > 0, "positive", "negative")
  ) %>%
  ggplot(aes(x = stool_abund, y = sputum_abund, fill = paste(stool_asv, stool_Genus,sep="_"), color=paste(stool_asv, stool_Genus,sep="_"), shape = rho_sign)) +
  geom_point(alpha = 0.8, size = 4) +
  scale_color_manual(values = genus_colors_new) +
  scale_fill_manual(values = genus_colors_new) +
  scale_shape_manual(values = c("positive" = 24, "negative" = 25)) +  # 24 = triangle up, 25 = triangle down
  scale_x_log10(breaks = log_breaks, labels = log_labels ) +
  scale_y_log10(breaks = log_breaks, labels = log_labels ) +
  labs(x = "Stool rel. abundance (%)",y = "Sputum rel. abundance (%)", color = "Genus"
  ) +
  theme_minimal(base_size = 14) +
  theme( legend.position = "right", panel.grid.minor = element_blank(), legend.text = element_text(face="italic"))+
  guides(shape=guide_legend(nrow = 2, title = "Spearman rho"),color= guide_legend(override.aes = list(size = 4)), fill="none")

p11

saveRDS(p11, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/correlation_spu_st.rds")
```
# Venn plot of shared ASVs
## overall the whole data set
```{r}
library(eulerr)
library(microViz)
ps_full_fil<- tax_filter(ps_full, min_prevalence = 1)
ps_full_fil <- subset_samples(ps_full_fil, project=="IMP" ) # work with CF samples only
summary(as_factor(sample_data(ps_full_fil)$material))
ps_venn(ps_full_fil, group = "material")

list <- ps_venn(ps_full_fil, group = "material", plot = F)

# Fit a diagram with proportional circles
combo <- c(Sputum = 168, Stool = 1973, Throat=1631,  "Sputum&Stool" = 17, "Sputum&Throat" = 257, "Sputum&Stool&Throat" = 190, "Throat&Stool" = 159)
fit1 <- euler(combo)

# Investigate the fit
fit1

venn1 <- plot(fit1, quantities = T,
     fills = list(fill = c("#CCB22BFF", "#A68A7BFF", "#6FB899FF"), alpha = 0.8),
     labels = list(col = "black", font = 2, cex=2.5, ps=2.5))

venn1 <- plot(fit1, 
     quantities = list(cex = 2),  # increase font size here
     fills = list(fill = c("#CCB22BFF", "#A68A7BFF", "#6FB899FF"), alpha = 0.8),
     labels = list(col = "black", font = 2, cex = 2.5), outside=T)

venn1 <- as_ggplot(venn1)
venn1
ggsave("figures/venn_all.pdf")

venn1_woLables <- plot(fit1,
     quantities = list(cex = 2),
     fills = list(fill = c("#CCB22BFF", "#A68A7BFF", "#6FB899FF"), alpha = 0.8),
     labels = FALSE)  # Turn off default labels

venn1_woLables<- as_ggplot(venn1_woLables)
saveRDS(venn1_woLables, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/venn_spu_st_thr.rds")
```
# Ordination on generalist taxa across the data set
The idea is that ASVs shared across all 3 sample types are considered generalists, the others would be habitat-specific hence specialists
```{r}
# Assume your full phyloseq object is: ps_full_fil
# Extract metadata
meta_df <- data.frame(sample_data(ps_full_fil))
otu_mat <- as(otu_table(ps_full_fil), "matrix")
taxa_are_rows <- taxa_are_rows(ps_full_fil)

# Convert to presence/absence
otu_bin <- otu_mat
otu_bin[otu_bin > 0] <- 1

# Make sure OTUs are rows
if (!taxa_are_rows) {
  otu_bin <- t(otu_bin)
}
# Add metadata to identify patient-timepoint groups
meta_df$group_id <- paste(meta_df$id.x, meta_df$visit_cal_cor, sep = "_")

# Split data by group
shared_asvs_list <- list()
specific_asvs_list <- list()

group_ids <- unique(meta_df$group_id)

for (gid in group_ids) {
  group_samples <- rownames(meta_df[meta_df$group_id == gid, ])
  group_otu <- otu_bin[, group_samples, drop = FALSE]
  group_meta <- meta_df[group_samples, ]

  # Check that all 3 sites are present
  if (length(unique(group_meta$material)) == 3) {
    site_asvs <- split(colnames(group_otu)[colSums(group_otu) > 0], group_meta$material)

    # Shared across all 3 sites
    shared_asvs <- Reduce(intersect, lapply(site_asvs, function(samples) {
      rownames(group_otu)[rowSums(group_otu[, samples, drop = FALSE]) > 0]
    }))
    
    # Site-specific ASVs (present in one site, not the others)
    site_specific_asvs <- unlist(lapply(names(site_asvs), function(site) {
      site_samples <- site_asvs[[site]]
      present <- rownames(group_otu)[rowSums(group_otu[, site_samples, drop = FALSE]) > 0]
      absent <- rownames(group_otu)[rowSums(group_otu[, !colnames(group_otu) %in% site_samples, drop = FALSE]) == 0]
      intersect(present, absent)
    }))

    shared_asvs_list[[gid]] <- shared_asvs
    specific_asvs_list[[gid]] <- site_specific_asvs
  }
}

# Combine unique sets
shared_asvs_all <- unique(unlist(shared_asvs_list))
specific_asvs_all <- unique(unlist(specific_asvs_list))

ps_shared <- prune_taxa(shared_asvs_all, ps_full_fil)
ps_specific <- prune_taxa(specific_asvs_all, ps_full_fil)

# Transform to relative abundance
ps_shared_rel <- transform_sample_counts(ps_shared, function(x) x / sum(x))
ps_specific_rel <- transform_sample_counts(ps_specific, function(x) x / sum(x))

# PCoA on Bray–Curtis
ord_shared <- ordinate(ps_shared_rel, method = "PCoA", distance = "bray")
ord_specific <- ordinate(ps_specific_rel, method = "PCoA", distance = "bray")

# Plot
p1 <- plot_ordination(ps_shared_rel, ord_shared, color = "material") +
  ggtitle("Ordination based on ASVs shared across all three sites") +
  theme_minimal()

p2 <- plot_ordination(ps_specific_rel, ord_specific, color = "material") +
  ggtitle("Ordination based on site-specific ASVs") +
  theme_minimal()

library(patchwork)
p1 + p2
```

```{r}
# ps_shared = only ASVs shared across all three body sites

# Calculate Bray-Curtis distance
set.seed(100)
BC_dist_shared <- phyloseq::distance(ps_shared_rel, method = "bray")

# Extract metadata
metadata_shared <- as(sample_data(ps_shared_rel), "data.frame")

# Run stratified PERMANOVA with subject ID as strata
res_shared <- vegan::adonis2(
  formula = BC_dist_shared ~ material + visit_sum + id.x,
  data = metadata_shared,
  permutations = 999,
  by = "margin",
  strata = metadata_shared$id.x
)

# Format result
res_shared <- as_tibble(res_shared, rownames = "term") %>%
  filter(term != "Residual", term != "Total") %>%
  mutate(data_set = "Shared ASVs", 
         formula = "BC_dist ~ material + visit_sum + id.x",
         N = nrow(metadata_shared))
res_shared
```

```{r}
# Assume you've already created a phyloseq object:
# ps_specific = only ASVs specific across all three body sites

# Calculate Bray-Curtis distance
set.seed(100)
BC_dist_specific <- phyloseq::distance(ps_specific_rel, method = "bray")

# Extract metadata
metadata_specific <- as(sample_data(ps_specific_rel), "data.frame")

# Run stratified PERMANOVA with subject ID as strata
res_specific <- vegan::adonis2(
  formula = BC_dist_specific ~ material + visit_sum + id.x,
  data = metadata_specific,
  permutations = 999,
  by = "margin",
  strata = metadata_specific$id.x
)

# Format result
res_specific <- as_tibble(res_specific, rownames = "term") %>%
  filter(term != "Residual", term != "Total") %>%
  mutate(data_set = "specific ASVs", 
         formula = "BC_dist ~ material + visit_sum + id.x",
         N = nrow(metadata_specific))

res_specific 
```

# repeat this analysis for true triplets (where a patient provided all 3 sample types at the same time point)
```{r}
library(dplyr)
library(phyloseq)

# Extract metadata
meta <- data.frame(sample_data(ps_full_fil))

# Create unique group ID per individual and timepoint
meta$group_id <- paste(meta$id.x, meta$visit_cal_cor, sep = "_")

# Count how many sample types per group_id
group_info <- meta %>%
  group_by(group_id) %>%
  summarise(
    n_sites = n_distinct(material),
    n_samples = n(),
    .groups = "drop"
  )

# Keep only groups with all 3 sites represented
valid_groups <- group_info %>%
  filter(n_sites == 3, n_samples == 3) %>%
  pull(group_id)

# Subset metadata to those valid triplets
meta_paired <- meta %>% filter(group_id %in% valid_groups)
summary(as_factor(meta_paired$id.x))
summary(as_factor(meta_paired$id_visit))
summary(as_factor(meta_paired$visit_sum))

# Subset phyloseq object to only those samples
ps_paired_triplets <- prune_samples(rownames(meta_paired), ps_full_fil)

# Convert to binary presence/absence
ps_bin <- transform_sample_counts(ps_paired_triplets, function(x) ifelse(x > 0, 1, 0))
otu_bin <- as(otu_table(ps_bin), "matrix")
if (!taxa_are_rows(ps_bin)) otu_bin <- t(otu_bin)

meta_paired <- data.frame(sample_data(ps_bin))
meta_paired$group_id <- paste(meta_paired$id.x, meta_paired$visit_cal_cor, sep = "_")

# Loop to get ASVs shared across 3 sites per group_id
shared_asvs_list <- lapply(unique(meta_paired$group_id), function(gid) {
  sids <- rownames(meta_paired[meta_paired$group_id == gid, ])
  present_mat <- otu_bin[, sids]
  asvs_shared <- rownames(present_mat)[rowSums(present_mat) == 3]
  return(asvs_shared)
})

asvs_shared_all_triplets <-unlist(shared_asvs_list)
ASV_shared_triplets_count <-  as.data.frame(summary(as_factor(asvs_shared_all_triplets)))

ASV_shared_triplets_count<- ASV_shared_triplets_count %>% 
  rownames_to_column("ASV") %>% 
  rename(Count= `summary(as_factor(asvs_shared_all_triplets))`)

# Loop to get ASVs present in only one sample per triplet
specific_asvs_list <- lapply(unique(meta_paired$group_id), function(gid) {
  sids <- rownames(meta_paired[meta_paired$group_id == gid, ])
  present_mat <- otu_bin[, sids]
  asvs_specific <- rownames(present_mat)[rowSums(present_mat) == 1]
  return(asvs_specific)
})

# Combine and get frequency across triplets
asvs_specific_all <- unlist(specific_asvs_list)

ASV_specific_triplets_count <- as.data.frame(table(asvs_specific_all)) %>%
  rename(ASV = asvs_specific_all, Count = Freq)

# Subset phyloseq object to those ASVs
ps_shared_triplets <- prune_taxa(ASV_shared_triplets_count$ASV, ps_paired_triplets)


# Subset phyloseq object to those ASVs
# Get all taxa names from the full paired dataset
all_taxa <- taxa_names(ps_paired_triplets)

# Identify ASVs that are NOT shared
non_shared_asvs <- setdiff(all_taxa, as.character(ASV_shared_triplets_count$ASV))

# Prune to only non-shared ASVs
ps_specific_triplets <- prune_taxa(non_shared_asvs, ps_paired_triplets)

# Transform to relative abundance
ps_shared_triplets_rel <- transform_sample_counts(ps_shared_triplets, function(x) x / sum(x))
ps_specific_triplets_rel <- transform_sample_counts(ps_specific_triplets, function(x) x / sum(x))

# PCoA on Bray–Curtis
ord_shared_t <- ordinate(ps_shared_triplets_rel, method = "PCoA", distance = "bray")
ord_specific_t <- ordinate(ps_specific_triplets_rel, method = "PCoA", distance = "bray")

# Plot
p3 <- plot_ordination(ps_shared_triplets_rel, ord_shared_t, color = "material") +
  ggtitle("ASVs shared across all three sites in paired samples") +
  theme_minimal()

p4 <- plot_ordination(ps_specific_triplets_rel, ord_specific_t, color = "material") +
  ggtitle("Site-specific ASVs in paired samples") +
  theme_minimal()

library(patchwork)
p3 + p4
```

```{r}
# Calculate Bray-Curtis distance
set.seed(100)
BC_dist_shared_t <- phyloseq::distance(ps_shared_triplets_rel, method = "bray")

# Extract metadata
metadata_shared_t <- as(sample_data(ps_shared_triplets_rel), "data.frame")

# Run stratified PERMANOVA with subject ID as strata
res_shared_t <- vegan::adonis2(
  formula = BC_dist_shared_t ~ material + visit_sum + id.x,
  data = metadata_shared_t,
  permutations = 999,
  by = "margin",
  strata = metadata_shared_t$id.x
)

# Format result
res_shared_t <- as_tibble(res_shared_t, rownames = "term") %>%
  filter(term != "Residual", term != "Total") %>%
  mutate(data_set = "shared ASVs in triplets", 
         formula = "BC_dist ~ material + visit_sum + id.x",
         N = nrow(metadata_shared_t))
res_shared_t
```

```{r}
# Calculate Bray-Curtis distance
set.seed(100)
BC_dist_specific_t <- phyloseq::distance(ps_specific_triplets_rel, method = "bray")

# Extract metadata
metadata_specific_t <- as(sample_data(ps_specific_triplets_rel), "data.frame")

# Run stratified PERMANOVA with subject ID as strata
res_specific_t <- vegan::adonis2(
  formula = BC_dist_specific_t ~ material + visit_sum + id.x,
  data = metadata_specific_t,
  permutations = 999,
  by = "margin",
  strata = metadata_specific_t$id.x
)

# Format result
res_specific_t <- as_tibble(res_specific_t, rownames = "term") %>%
  filter(term != "Residual", term != "Total") %>%
  mutate(data_set = "specific ASVs in triplets", 
         formula = "BC_dist ~ material + visit_sum + id.x",
         N = nrow(metadata_specific_t))
res_specific_t 
```

```{r}
res_df <- rbind(res_shared, res_specific, res_shared_t, res_specific_t)

# Add to existing results object
res_comb <- rbind(res_df[, 1:9], res_df)

# Add significance label again
res_comb <- res_comb %>%
  mutate(Significance = case_when(
    `Pr(>F)` <= 0.001 ~ "≤ 0.001",
    `Pr(>F)` <= 0.01 ~ "≤ 0.01",
    `Pr(>F)` <= 0.05 ~ "≤ 0.05",
    TRUE ~ "ns"
  ))

# Update y-axis label
res_comb <- res_comb %>% 
  mutate(ylab = paste(data_set, ", N=", N, sep = ""))

res_comb %>%
  ggplot(aes(y = term, x = ylab)) +
  geom_point(aes(fill = Significance, size = R2 * 100), shape = 21, color = "black") +
  scale_fill_manual(values = c("≤ 0.001" = "#765085", "≤ 0.01" = "#31A1B3FF", "≤ 0.05" = "#B9A8D0", "ns" = "grey")) +
  scale_size_continuous(range = c(4, 12)) +
  theme_minimal(base_size = 14) +
  scale_y_discrete(labels = c("id.x" = "ID", "material" = "Sample type", "visit_sum" = "Months from\ntreatment start")) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
    axis.text.y = element_text(size = 16),
    legend.title.position = "top",
    axis.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 16)
  ) +
  labs(fill = "p value", size = "Explained variance (%)") +
  ylab("") +
  xlab("")
```

# heatmap of shared ASVs across sites
```{r}
library(phyloseq)
library(dplyr)

# Filter shared ASVs (e.g., detected in >4 triplets)
asvs_shared_5plus <- ASV_shared_triplets_count %>%
  filter(Count > 4) %>%
  pull(ASV) %>%
  as.character()

# Subset phyloseq object to these ASVs
ps_shared_5plus <- prune_taxa(asvs_shared_5plus, ps_paired_triplets)

# Normalize to relative abundance
ps_shared_5plus_rel <- transform_sample_counts(ps_shared_5plus, function(x) x / sum(x))

# Extract OTU table and metadata
heatmap_df<- psmelt(ps_shared_5plus_rel)

heatmap_df %>% 
  mutate(Genus_asv = paste(OTU,Genus,  sep="_")) %>% 
ggplot(aes(x = x_sample_id, y = Genus_asv, fill = Abundance)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "#31A1B3", name = "Rel. abundance") +
  facet_grid(~ material, scales = "free_x", space = "free_x") +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  ) +
  labs(
    x = "Samples",
    y = "Shared ASVs (detected in >4 triplets)",
    title = "Heatmap of shared ASV relative abundances per body site"
  )
```

# Jaccard distance across data set, to quantify overlap
```{r}

jaccard_dist <- phyloseq::distance(ps_full_fil, method = "jaccard", binary = FALSE)

# Convert distance matrix to a long data frame
jaccard_df <- as.data.frame(as.matrix(jaccard_dist)) %>%
  rownames_to_column("Sample1") %>%
  pivot_longer(-Sample1, names_to = "Sample2", values_to = "JaccardDist") %>%
  filter(Sample1 < Sample2)  # to avoid duplicates and self-comparisons

# Add metadata (e.g., sample type) to each sample
sample_data_df <- data.frame(sample_data(ps_full_fil)) %>%
  rownames_to_column("SampleID")

jaccard_df <- jaccard_df %>%
  left_join(sample_data_df, by = c("Sample1" = "SampleID")) %>%
  rename(site1 = material) %>%
  left_join(sample_data_df, by = c("Sample2" = "SampleID")) %>%
  rename(site2 = material)

# 5. Filter for comparisons between different body sites (optional)
jaccard_cross_type <- jaccard_df %>%
  filter(site1 != site2)

jaccard_cross_type <- jaccard_cross_type %>%
  mutate(comparison= case_when(site1=="Sputum"&site2=="Stool"~"Sputum-Stool",site2=="Sputum"&site1=="Stool"~"Sputum-Stool",site1=="Sputum"&site2=="Throat"~"Sputum-Throat", site2=="Sputum"&site1=="Throat"~"Sputum-Throat", site1=="Stool"&site2=="Throat"~"Stool-Throat", site2=="Stool"&site1=="Throat"~"Stool-Throat"))

# create 4 data set groups
  # a) same id, same timepoint, b) same id, different time point, c) different id, same time point, d) different id, different time point
jaccard_cross_type_df <- jaccard_cross_type %>% 
  select(JaccardDist, comparison, id.x.x, id.x.y, comparison, visit_cal_cor.x, visit_cal_cor.y) %>% 
  mutate(data_set= case_when(id.x.x==id.x.y & visit_cal_cor.x==visit_cal_cor.y~"paired", id.x.x==id.x.y & visit_cal_cor.x!=visit_cal_cor.y~"paired id, different time point", id.x.x!=id.x.y & visit_cal_cor.x==visit_cal_cor.y~"unpaired, same time point", id.x.x!=id.x.y & visit_cal_cor.x!=visit_cal_cor.y~"unpaired, different time point"))

jaccard_cross_type_df$comparison <- factor(jaccard_cross_type_df$comparison, levels = c("Sputum-Throat", "Sputum-Stool", "Stool-Throat"))

# Step 1: Compute counts per group
counts <- jaccard_cross_type_df %>% 
  group_by(comparison, data_set) %>% 
  summarise(N = sum(!is.na(JaccardDist)), .groups = "drop")

# Step 2: Create labeled versions of `data_set` with counts

jaccard_plot_df <- jaccard_cross_type_df %>%
  left_join(counts, by = c("comparison", "data_set")) %>%
  mutate(data_set_label = paste0(data_set, "\n(n=", N, ")")) %>% 
  mutate(x_order = paste0(comparison, "'", data_set, "_", N)) %>%  # unique per dataset
  mutate(x_order = factor(x_order, levels = unique(x_order[order(N)]))) %>% 
  mutate(x_lab = paste0("N=", str_extract(x_order, "[^_]+$")))  # everything after last "_"

# Create named labels for the x-axis
x_labels_named <- jaccard_plot_df %>%
  distinct(x_order, x_lab) %>%
  deframe()  # creates named vector: names = x_order, values = x_lab

# Now use this in the plot
p4 <- ggplot(jaccard_plot_df, aes(x = x_order, y = JaccardDist, fill = data_set)) +
  geom_boxplot(outlier.alpha = 0.4, alpha = 0.7) +
  theme_minimal(base_size = 13) +
  scale_fill_manual(values = c("#31A1B3",  "#20B2AA","#765085", "#E07B91"))+
  scale_x_discrete(labels = x_labels_named) +  # fixed axis labels
  facet_grid(~comparison, scales = "free") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    strip.text = element_text(face = "bold")
  ) + 
  labs(fill = "Comparison between", y= "Jaccard distance", x="")

p4

ggsave( "figures/jaccard_across_type.pdf", p4,height = 4, width = 8)
```

# BC dissimilarity accross data sets
```{r}
ps_full_fil_relab <- transform_sample_counts(ps_full_fil,function(x) x/sum(x))

bc_dist <- phyloseq::distance(ps_full_fil_relab, method = "bray")

# Convert distance matrix to a long data frame
bc_df <- as.data.frame(as.matrix(bc_dist)) %>%
  rownames_to_column("Sample1") %>%
  pivot_longer(-Sample1, names_to = "Sample2", values_to = "bcDist") %>%
  filter(Sample1 < Sample2)  # to avoid duplicates and self-comparisons

# Add metadata (e.g., sample type) to each sample
sample_data_df <- data.frame(sample_data(ps_full_fil)) %>%
  rownames_to_column("SampleID")

bc_df <- bc_df %>%
  left_join(sample_data_df, by = c("Sample1" = "SampleID")) %>%
  rename(site1 = material) %>%
  left_join(sample_data_df, by = c("Sample2" = "SampleID")) %>%
  rename(site2 = material)

# 5. Filter for comparisons between different body sites (optional)
bc_cross_type <- bc_df %>%
  filter(site1 != site2)

bc_cross_type <- bc_cross_type %>%
  mutate(comparison= case_when(site1=="Sputum"&site2=="Stool"~"Sputum-Stool",site2=="Sputum"&site1=="Stool"~"Sputum-Stool",site1=="Sputum"&site2=="Throat"~"Sputum-Throat", site2=="Sputum"&site1=="Throat"~"Sputum-Throat", site1=="Stool"&site2=="Throat"~"Stool-Throat", site2=="Stool"&site1=="Throat"~"Stool-Throat"))

# create 4 data set groups
  # a) same id, same timepoint, b) same id, different time point, c) different id, same time point, d) different id, different time point
bc_cross_type_df <- bc_cross_type %>% 
  select(bcDist, comparison, id.x.x, id.x.y, comparison, visit_cal_cor.x, visit_cal_cor.y) %>% 
  mutate(data_set= case_when(id.x.x==id.x.y & visit_cal_cor.x==visit_cal_cor.y~"paired", id.x.x==id.x.y & visit_cal_cor.x!=visit_cal_cor.y~"paired id, different time point", id.x.x!=id.x.y & visit_cal_cor.x==visit_cal_cor.y~"unpaired, same time point", id.x.x!=id.x.y & visit_cal_cor.x!=visit_cal_cor.y~"unpaired, different time point"))

bc_cross_type_df$comparison <- factor(bc_cross_type_df$comparison, levels = c("Sputum-Throat", "Sputum-Stool", "Stool-Throat"))

# Step 1: Compute counts per group
counts <- bc_cross_type_df %>% 
  group_by(comparison, data_set) %>% 
  summarise(N = sum(!is.na(bcDist)), .groups = "drop")

# Step 2: Create labeled versions of `data_set` with counts
bc_plot_df <- bc_cross_type_df %>%
  left_join(counts, by = c("comparison", "data_set")) %>%
  mutate(data_set_label = paste0(data_set, "\n(n=", N, ")")) %>% 
  mutate(x_order = paste0(comparison, "'", data_set, "_", N)) %>%  # unique per dataset
  mutate(x_order = factor(x_order, levels = unique(x_order[order(N)]))) %>% 
  mutate(x_lab = paste0("N=", str_extract(x_order, "[^_]+$")))  # everything after last "_"

# Create named labels for the x-axis
x_labels_named <- bc_plot_df %>%
  distinct(x_order, x_lab) %>%
  deframe()  # creates named vector: names = x_order, values = x_lab

# Now use this in the plot
p3 <- ggplot(bc_plot_df, aes(x = x_order, y = bcDist, fill = data_set)) +
  geom_boxplot(outlier.alpha = 0.4, alpha = 0.7) +
  theme_minimal(base_size = 14) +
  scale_fill_manual(values = c("#31A1B3",  "#20B2AA","#765085", "#E07B91"))+
  scale_x_discrete(labels = x_labels_named) +  # fixed axis labels
  facet_grid(~comparison, scales = "free") +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    strip.text = element_text(face = "bold")
  ) + 
  labs(fill = "Comparison between", y= "BC dissimilarity", x="")


p3

ggsave( "figures/bc_across_type.pdf", p3,height = 4, width = 8)
saveRDS(p3, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/bc_across_datasets.rds")

ggarrange(p4, p3,nrow = 1,common.legend = TRUE, legend = "bottom")

ggsave( "figures/jaccard_bc_across_type.pdf", height = 4, width = 12)
```

# Congruence of alpha diversity across sample type
```{r}
# Step 1: Calculate alpha diversity and join metadata
alpha_df <- estimate_richness(ps_full_fil, measures = c("Shannon", "Observed")) %>%
  rownames_to_column("SampleID") %>%
  mutate(SampleID = str_remove(SampleID, "X")) %>% 
  left_join(sample_data(ps_full_fil) %>% data.frame() %>% rownames_to_column("SampleID"))

alpha_df <- alpha_df %>% 
  select(x_sample_id, id.x, id_visit, id_visit_mat, visit_cal_cor, material, Shannon, Observed)

alpha_df_2 <- alpha_df %>% 
  rename_with(~ paste0(., "_2"))

# Multiply by all possible combinations
alpha_cross_df <- alpha_df %>% 
  cross_join(alpha_df_2)

alpha_cross_df <- alpha_cross_df %>%
  #filter(x_sample_id != x_sample_id_2) %>%  # remove same sample
  mutate(pair_id = map2_chr(x_sample_id, x_sample_id_2, ~ paste(sort(c(.x, .y)), collapse = "_"))) %>%
  distinct(pair_id, .keep_all = TRUE)

# Step 5: Define comparison type
alpha_cross_df <- alpha_cross_df %>%
  mutate(comparison = case_when(
    material == "Sputum" & material_2 == "Stool" ~ "Sputum-Stool",
    material_2 == "Sputum" & material == "Stool" ~ "Sputum-Stool",
    material == "Sputum" & material_2 == "Throat" ~ "Sputum-Throat",
    material_2 == "Sputum" & material == "Throat" ~ "Sputum-Throat",
    material == "Stool" & material_2 == "Throat" ~ "Stool-Throat",
    material_2 == "Stool" & material == "Throat" ~ "Stool-Throat",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(comparison))

# Step 3: Determine if the comparison is paired or unpaired
alpha_cross_df <- alpha_cross_df %>%
  mutate(
    data_set_type = case_when(
      id.x == id.x_2 & visit_cal_cor == visit_cal_cor_2 ~ "paired, same time point", # Paired within same time point
      id.x == id.x_2 & visit_cal_cor != visit_cal_cor_2 ~ "paired, different time point", # Paired, different time points
      id.x != id.x_2 & visit_cal_cor != visit_cal_cor_2 ~  "unpaired, different time point",  # Other cases are unpaired, different time points
      id.x != id.x_2 & visit_cal_cor == visit_cal_cor_2 ~ "unpaired, same time point"
    )
  )

summary(as_factor(alpha_cross_df$data_set_type))

alpha_cross_df %>% 
ggplot(aes(Shannon, Shannon_2))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_grid(data_set_type~comparison)

alpha_cross_df %>% 
  filter(data_set_type == "paired, same time point") %>% 
  ggplot(aes(x = Shannon, y = Shannon_2)) +
  geom_point(alpha = 0.6, color = "#555555", size = 2) +
  geom_smooth(method = "lm", color = "#31A1B3", se = TRUE, linewidth = 1.2) +
  facet_grid(~comparison) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Shannon Diversity (Sample 1)",
    y = "Shannon Diversity (Sample 2)",
    title = "Alpha Diversity Comparison by Sample Material Pair",
    subtitle = "Only paired samples from the same time point"
  ) +
  theme(
    strip.text = element_text(face = "bold"),
    panel.spacing = unit(1.2, "lines"),
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12),
    axis.title = element_text(face = "bold"),
    legend.position = "none"
  )


alpha_cross_df %>% 
  filter(data_set_type == "paired, same time point") %>% filter(comparison=="Sputum-Throat")

# Correlations
summary(lmerTest::lmer(Shannon ~ Shannon_2+(1|id.x), data=alpha_cross_df %>% 
  filter(data_set_type == "paired, same time point") %>% filter(comparison=="Sputum-Throat")))

summary(lmerTest::lmer(Shannon ~ Shannon_2+(1|id.x), data=alpha_cross_df %>% 
  filter(data_set_type == "paired, same time point") %>% filter(comparison=="Sputum-Stool")))

summary(lmerTest::lmer(Shannon ~ Shannon_2+(1|id.x), data=alpha_cross_df %>% 
  filter(data_set_type == "paired, same time point") %>% filter(comparison=="Stool-Throat")))


# Get model results for each comparison group
model_results <- alpha_cross_df %>%
  filter(data_set_type == "paired, same time point") %>%
  group_by(comparison) %>%
  group_map(~ {
    model <- lmerTest::lmer(Shannon ~ Shannon_2 + (1 | id.x)+ (1 | visit_cal_cor), data = .x)
    tidy_model <- broom.mixed::tidy(model)
    slope_row <- tidy_model %>% filter(term == "Shannon_2")
    tibble(
      comparison = .y$comparison,
      slope = slope_row$estimate,
      p.value = slope_row$p.value
    )
  }) %>%
  bind_rows()


# Base data
plot_data <- alpha_cross_df %>% 
  filter(data_set_type == "paired, same time point")

# Join labels to base data so each facet has the right annotation
plot_data <- plot_data %>%
  left_join(model_results, by = "comparison") %>% 
  mutate(significance= case_when(p.value<=0.001~"***", p.value<=0.01~"**",  p.value>=0.05~ "ns", p.value<0.05~"*")) %>% 
  mutate(label=paste0("E=",round(slope, 2), " ", significance))

plot_data$comparison<- factor(plot_data$comparison, levels =c("Sputum-Throat", "Sputum-Stool", "Stool-Throat"))

# Create the annotated plot
p5 <- ggplot(plot_data, aes(x = Shannon_2, y = Shannon)) +
  geom_point(alpha = 0.6, color = "#555555", size = 2) +
  geom_smooth(method = "lm", color = "#31A1B3", se = TRUE, linewidth = 1.2) +
  facet_grid(~comparison) +
  geom_text(aes(x = 3.2, y = -Inf, label = label), 
            hjust = 1.1, vjust = -1.1, size = 4, fontface = "italic", inherit.aes = FALSE) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Shannon Diversity",
    y = "Shannon Diversity"
  ) +
  theme(strip.text = element_text(face = "bold"))
p5



# Get model results for each comparison group
model_results <- alpha_cross_df %>%
  filter(data_set_type == "paired, same time point") %>%
  group_by(comparison) %>%
  group_map(~ {
    model <- lmerTest::lmer(Observed ~ Observed_2 + (1 | id.x)+ (1 | visit_cal_cor), data = .x)
    tidy_model <- broom.mixed::tidy(model)
    slope_row <- tidy_model %>% filter(term == "Observed_2")
    tibble(
      comparison = .y$comparison,
      slope = slope_row$estimate,
      p.value = slope_row$p.value
    )
  }) %>%
  bind_rows()


# Base data
plot_data <- alpha_cross_df %>% 
  filter(data_set_type == "paired, same time point")

# Join labels to base data so each facet has the right annotation
plot_data <- plot_data %>%
  left_join(model_results, by = "comparison") %>% 
  mutate(significance= case_when(p.value<=0.001~"***", p.value<=0.01~"**",  p.value>=0.05~ "ns", p.value<0.05~"*")) %>% 
  mutate(label=paste0("E=",round(slope, 2), " ", significance))

plot_data$comparison<- factor(plot_data$comparison, levels =c("Sputum-Throat", "Sputum-Stool", "Stool-Throat"))

# Create the annotated plot
p6 <- ggplot(plot_data, aes(x = Observed_2, y = Observed)) +
  geom_point(alpha = 0.6, color = "#555555", size = 2) +
  geom_smooth(method = "lm", color = "#31A1B3", se = TRUE, linewidth = 1.2) +
  facet_grid(~comparison, scales = "free") +
  geom_text(aes(x = 115, y = 165, label = label), 
            hjust = 1.1, vjust = -1.1, size = 4, fontface = "italic", inherit.aes = FALSE) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Observed ASVs",
    y = "Observed ASVs"
  ) +
  theme(strip.text = element_text(face = "bold"))
p6

p5p6 <- ggarrange(p6,p5,nrow = 1)

saveRDS(p5p6, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/congruence_alpha_div.rds")

```

# Shared ASVs between paired samples
```{r, eval=FALSE, include=FALSE}
ps_bin <- transform_sample_counts(ps_full_fil , function(x) x/sum(x))

# Extract OTU/ASV table and sample data
otu_bin <- as(otu_table(ps_bin), "matrix")
sample_df <- as(sample_data(ps_bin), "data.frame")

otu_bin <- t(otu_bin)

# Make sure sample IDs are in the same order
otu_bin <- otu_bin[, sample_df$x_sample_id]

# Pair samples by SubjectID and Timepoint
paired_samples <- sample_df %>%
  select(x_sample_id, id.x, visit_cal_cor, material) %>%
  group_by(id.x, visit_cal_cor) %>%
  filter(n() > 1) %>%
  summarise(
    pairs = list(combn(x_sample_id, 2, simplify = FALSE)),
    .groups = "drop"
  ) %>%
  unnest(pairs)

shared_asv_results <- paired_samples %>%
  rowwise() %>%
  mutate(
    sample1 = pairs[[1]],
    sample2 = pairs[[2]],
    site1 = sample_df$material[sample_df$x_sample_id == sample1],
    site2 = sample_df$material[sample_df$x_sample_id == sample2],
    shared_asvs = list(intersect(
      names(which(otu_bin[, sample1] > 0)),
      names(which(otu_bin[, sample2] > 0))
    )),
    shared_reads_1 = sum(otu_bin[shared_asvs[[1]], sample1]),# because we worked here with relative abundances the sum of shared asvs is already the proportion
    shared_reads_2 = sum(otu_bin[shared_asvs[[1]], sample2])
  ) %>%
  ungroup()

# Plot
shared_long <- shared_asv_results %>%
  pivot_longer(cols = c(shared_reads_1, shared_reads_2),
               names_to = "Sample", values_to = "SharedProp") %>%
  mutate(Site = ifelse(Sample == "shared_reads_1", site1, site2)) %>% 
  mutate(Site= case_when(Site==1~"Sputum", Site==2~"Throat", Site==3~"Stool")) %>% 
  mutate(comparison= case_when(site1=="Sputum"&site2=="Stool"~"Sputum-Stool",site2=="Sputum"&site1=="Stool"~"Sputum-Stool",site1=="Sputum"&site2=="Throat"~"Sputum-Throat", site2=="Sputum"&site1=="Throat"~"Sputum-Throat", site1=="Stool"&site2=="Throat"~"Stool-Throat", site2=="Stool"&site1=="Throat"~"Stool-Throat")) %>% 
  mutate(id_visit=paste(id.x, visit_cal_cor,sep="_"))

p7 <- ggplot(shared_long, aes(x = Site, y = SharedProp*100, fill=Site)) +
  geom_boxplot(alpha=0.6) +
  labs(title = "Proportion of Shared ASVs in paired samples", y = "Proportion (%) of shared ASVs (by relative abundance)", x = "")+
  facet_grid(~comparison, scales = "free_x")+
  scale_y_log10(breaks = c(0.1, 1, 10, 50, 100))+
scale_fill_manual(values=c("#CCB22BFF", "#A68A7BFF", "#6FB899FF"))+
  theme_classic()+
  theme(legend.position = "none")#+
  #geom_line(aes(group=id_visit), alpha=0.3)
p7

ggplot(shared_long, aes(x = comparison, y = SharedProp)) +
  geom_boxplot() +
  labs(title = "Proportion of Reads from Shared ASVs in paired samples", y = "Proportion", x = "Comparison")
```

# Shared ASVs between paired samples based presence/abscence
```{r}
ps_bin <- transform_sample_counts(ps_full_fil , function(x) x/sum(x))

# Convert to presence/absence
ps_presence <- transform_sample_counts(ps_full_fil, function(x) ifelse(x > 0, 1, 0))

# Extract OTU/ASV table and sample data
otu_bin <- as(otu_table(ps_presence), "matrix")
sample_df <- as(sample_data(ps_presence), "data.frame")

otu_bin <- t(otu_bin)

# Make sure sample IDs are in the same order
otu_bin <- otu_bin[, sample_df$x_sample_id]

# Pair samples by SubjectID and Timepoint
paired_samples <- sample_df %>%
  select(x_sample_id, id.x, visit_cal_cor, material) %>%
  group_by(id.x, visit_cal_cor) %>%
  filter(n() > 1) %>%
  summarise(
    pairs = list(combn(x_sample_id, 2, simplify = FALSE)),
    .groups = "drop"
  ) %>%
  unnest(pairs)

shared_asv_results <- paired_samples %>%
  rowwise() %>%
  mutate(
    sample1 = pairs[[1]],
    sample2 = pairs[[2]],
    site1 = sample_df$material[sample_df$x_sample_id == sample1],
    site2 = sample_df$material[sample_df$x_sample_id == sample2],
    
    shared_asvs = list(intersect(
      names(which(otu_bin[, sample1] > 0)),
      names(which(otu_bin[, sample2] > 0))
    )),
    
    n_shared_asvs = length(shared_asvs),
    
    total_asvs_sample1 = sum(otu_bin[, sample1]),
    total_asvs_sample2 = sum(otu_bin[, sample2]),
    
    prop_shared_sample1 = n_shared_asvs / total_asvs_sample1,
    prop_shared_sample2 = n_shared_asvs / total_asvs_sample2,
    
    prop_shared_avg = mean(c(prop_shared_sample1, prop_shared_sample2))
  ) %>%
  ungroup()

  
# Plot

shared_long_counts <- shared_asv_results %>%
  pivot_longer(cols = c(prop_shared_sample1, prop_shared_sample2),
               names_to = "Sample", values_to = "SharedProp") %>%
  mutate(Site = ifelse(Sample == "prop_shared_sample1", site1, site2)) %>% 
  mutate(Site= case_when(Site==1~"Sputum", Site==2~"Throat", Site==3~"Stool")) %>% 
  mutate(comparison= case_when(site1=="Sputum"&site2=="Stool"~"Sputum-Stool",site2=="Sputum"&site1=="Stool"~"Sputum-Stool",site1=="Sputum"&site2=="Throat"~"Sputum-Throat", site2=="Sputum"&site1=="Throat"~"Sputum-Throat", site1=="Stool"&site2=="Throat"~"Stool-Throat", site2=="Stool"&site1=="Throat"~"Stool-Throat")) %>% 
  mutate(id_visit=paste(id.x, visit_cal_cor,sep="_"))

p7 <- ggplot(shared_long_counts, aes(x = Site, y = SharedProp*100, fill=Site)) +
  geom_boxplot(alpha=0.6) +
  labs(title = "Proportion of Shared ASVs (total count)", y = "Proportion (%) of shared ASVs (total count)", x = "")+
  facet_grid(~comparison, scales = "free_x")+
  scale_y_log10(breaks = c(0.1, 1, 10, 50, 100))+
scale_fill_manual(values=c("#CCB22BFF", "#A68A7BFF", "#6FB899FF"))+
  theme_classic()+
  theme(legend.position = "none")#+
  #geom_line(aes(group=id_visit), alpha=0.3)
p7

ggplot(shared_long_counts, aes(x = comparison, y = SharedProp)) +
  geom_boxplot() +
  labs(title = "Proportion of Reads from Shared ASVs in paired samples", y = "Proportion", x = "Comparison")
```

# Proportion of ASVs in unpaired samples
```{r, eval=FALSE, include=FALSE}
# choose unpaired samples
alpha_cross_df %>% 
  filter(data_set_type=="unpaired, different time point")

# select pairs
unpaired_samples <- alpha_cross_df%>%
  select(x_sample_id, x_sample_id_2, id.x, id.x_2, visit_cal_cor, visit_cal_cor_2, material, material_2, data_set_type, comparison, pair_id) %>%
  filter(data_set_type=="unpaired, different time point") 
  

shared_asv_results_unpar <- unpaired_samples %>%
  rowwise() %>%
  mutate(
    sample1 = x_sample_id,
    sample2 = x_sample_id_2,
    site1 = sample_df$material[sample_df$x_sample_id == sample1],
    site2 = sample_df$material[sample_df$x_sample_id == sample2],
    shared_asvs = list(intersect(
      names(which(otu_bin[, sample1] > 0)),
      names(which(otu_bin[, sample2] > 0))
    ))) %>% 
  ungroup() %>%
  filter(lengths(shared_asvs) != 0) %>% 
  rowwise() %>% 
  mutate(shared_reads_1 = sum(otu_bin[shared_asvs[[1]], sample1]),# because we worked here with relative abundances the sum of shared asvs is already the proportion
    shared_reads_2 = sum(otu_bin[shared_asvs[[1]], sample2])
  ) %>%
  ungroup()

prop_0 <- unpaired_samples %>%
  rowwise() %>%
  mutate(
    sample1 = x_sample_id,
    sample2 = x_sample_id_2,
    site1 = sample_df$material[sample_df$x_sample_id == sample1],
    site2 = sample_df$material[sample_df$x_sample_id == sample2],
    shared_asvs = list(intersect(
      names(which(otu_bin[, sample1] > 0)),
      names(which(otu_bin[, sample2] > 0))
    ))) %>% 
  ungroup() %>%
  filter(lengths(shared_asvs) == 0) %>% 
  rowwise() 

#ADD the empty 0 proportion shared samples!!!!
prop_0 <- prop_0 %>%
  mutate(shared_reads_1 = as.integer(0), shared_reads_2 = as.integer(0))

shared_asv_results_unpar <- rbind(shared_asv_results_unpar, prop_0)

shared_long_unpar <- shared_asv_results_unpar %>%
  pivot_longer(cols = c(shared_reads_1, shared_reads_2),
               names_to = "Sample", values_to = "SharedProp") %>%
  mutate(Site = ifelse(Sample == "shared_reads_1", site1, site2)) %>% 
  mutate(Site= case_when(Site==1~"Sputum", Site==2~"Throat", Site==3~"Stool")) %>% 
  mutate(comparison= case_when(site1=="Sputum"&site2=="Stool"~"Sputum-Stool",site2=="Sputum"&site1=="Stool"~"Sputum-Stool",site1=="Sputum"&site2=="Throat"~"Sputum-Throat", site2=="Sputum"&site1=="Throat"~"Sputum-Throat", site1=="Stool"&site2=="Throat"~"Stool-Throat", site2=="Stool"&site1=="Throat"~"Stool-Throat")) %>% 
  mutate(id_visit=paste(id.x, visit_cal_cor,sep="_"))

p8 <- ggplot(shared_long_unpar, aes(x = Site, y = SharedProp*100, fill=Site)) +
  geom_boxplot(alpha=0.6) +
  labs(title = "Proportion of Shared ASVs in unpaired samples", y = "Proportion (%) of shared ASVs (by relative abundance)", x = "")+
  facet_grid(~comparison, scales = "free_x")+
  scale_y_log10(breaks = c(0.1, 1, 10, 50, 100))+
scale_fill_manual(values=c("#CCB22BFF", "#A68A7BFF", "#6FB899FF"))+
  theme_classic()+
  theme(legend.position = "none")#+
  #geom_line(aes(group=id_visit), alpha=0.3)

p8

ggplot(shared_long_unpar, aes(x = comparison, y = SharedProp)) +
  geom_boxplot() +
  labs(title = "Proportion of Reads from Shared ASVs in unpaired samples", y = "Proportion", x = "Comparison")
ggarrange(p7,p8, nrow = 1)
```


# Shared ASVs between unpaired samples based presence/abscence
```{r}
ps_bin <- transform_sample_counts(ps_full_fil , function(x) x/sum(x))

# Convert to presence/absence
ps_presence <- transform_sample_counts(ps_full_fil, function(x) ifelse(x > 0, 1, 0))

# Extract OTU/ASV table and sample data
otu_bin <- as(otu_table(ps_presence), "matrix")
sample_df <- as(sample_data(ps_presence), "data.frame")

otu_bin <- t(otu_bin)

# Make sure sample IDs are in the same order
otu_bin <- otu_bin[, sample_df$x_sample_id]

unpaired_samples <- alpha_cross_df%>%
  select(x_sample_id, x_sample_id_2, id.x, id.x_2, visit_cal_cor, visit_cal_cor_2, material, material_2, data_set_type, comparison, pair_id) %>%
  filter(data_set_type=="unpaired, different time point") 
  
shared_asv_results_unpar_counts <- unpaired_samples %>%
  rowwise() %>%
  mutate(
    sample1 = x_sample_id,
    sample2 = x_sample_id_2,
    site1 = sample_df$material[sample_df$x_sample_id == sample1],
    site2 = sample_df$material[sample_df$x_sample_id == sample2],
    
    shared_asvs = list(intersect(
      names(which(otu_bin[, sample1] > 0)),
      names(which(otu_bin[, sample2] > 0))
    )),
    
    n_shared_asvs = length(shared_asvs)) %>% 
    
    filter(n_shared_asvs != 0) %>% 
  
  mutate(
    total_asvs_sample1 = sum(otu_bin[, sample1]),
    total_asvs_sample2 = sum(otu_bin[, sample2]),
    
    prop_shared_sample1 = n_shared_asvs / total_asvs_sample1,
    prop_shared_sample2 = n_shared_asvs / total_asvs_sample2,
    
    prop_shared_avg = mean(c(prop_shared_sample1, prop_shared_sample2))) %>%
  ungroup()

prop_0 <- unpaired_samples %>%
  rowwise() %>%
  mutate(
    sample1 = x_sample_id,
    sample2 = x_sample_id_2,
    site1 = sample_df$material[sample_df$x_sample_id == sample1],
    site2 = sample_df$material[sample_df$x_sample_id == sample2],
    shared_asvs = list(intersect(
      names(which(otu_bin[, sample1] > 0)),
      names(which(otu_bin[, sample2] > 0))
    ))) %>% 
  ungroup() %>%
  filter(lengths(shared_asvs) == 0) %>% 
  rowwise() 

#ADD the empty 0 proportion shared samples!!!!
prop_0 <- prop_0 %>%
  mutate(prop_shared_sample1 = as.integer(0), prop_shared_sample2 = as.integer(0), prop_shared_avg = as.integer(0), n_shared_asvs = as.integer(0))

shared_asv_results_unpar_counts <- shared_asv_results_unpar_counts %>% 
  select(-c(total_asvs_sample1, total_asvs_sample2))

shared_asv_results_unpar_counts <- rbind(shared_asv_results_unpar_counts, prop_0)

# Plot

shared_long_counts_unpar <- shared_asv_results_unpar_counts %>%
 pivot_longer(cols = c(prop_shared_sample1, prop_shared_sample2),
               names_to = "Sample", values_to = "SharedProp") %>%
  mutate(Site = ifelse(Sample == "prop_shared_sample1", site1, site2)) %>% 
  mutate(Site= case_when(Site==1~"Sputum", Site==2~"Throat", Site==3~"Stool")) %>% 
  mutate(comparison= case_when(site1=="Sputum"&site2=="Stool"~"Sputum-Stool",site2=="Sputum"&site1=="Stool"~"Sputum-Stool",site1=="Sputum"&site2=="Throat"~"Sputum-Throat", site2=="Sputum"&site1=="Throat"~"Sputum-Throat", site1=="Stool"&site2=="Throat"~"Stool-Throat", site2=="Stool"&site1=="Throat"~"Stool-Throat")) %>% 
  mutate(id_visit=paste(id.x, visit_cal_cor,sep="_"))

p7 <- ggplot(shared_long_counts_unpar, aes(x = Site, y = SharedProp*100, fill=Site)) +
  geom_boxplot(alpha=0.6) +
  labs(title = "Proportion of Shared ASVs (total count)", y = "Proportion (%) of shared ASVs (total count)", x = "")+
  facet_grid(~comparison, scales = "free_x")+
  #scale_y_log10(breaks = c(0.1, 1, 10, 50, 100))+
scale_fill_manual(values=c("#CCB22BFF", "#A68A7BFF", "#6FB899FF"))+
  theme_classic()+
  theme(legend.position = "none")#+
  #geom_line(aes(group=id_visit), alpha=0.3)
p7

ggplot(shared_long_counts_unpar, aes(x = comparison, y = SharedProp)) +
  geom_boxplot() +
  labs(title = "Proportion of Reads from Shared ASVs in unpaired samples", y = "Proportion", x = "Comparison")
```

```{r, eval=FALSE}
shared_long$data_set_type <- "paired"

a <- shared_long %>% 
  select(comparison, SharedProp, Site, data_set_type, id.x)

b <- shared_long_unpar %>% 
  select(comparison, SharedProp, Site, data_set_type, id.x)

shared_asvs_comb <-  rbind(a,b)

lmer_stats <- shared_asvs_comb %>%
  group_by(comparison, Site) %>%
  group_map(~ {
    model <- lmerTest::lmer(SharedProp ~ data_set_type + (1 | id.x), data = .x)
    slope_info <- broom.mixed::tidy(model) %>%
      filter(term == "data_set_typeunpaired, different time point")
    tibble(
      comparison = .y$comparison[1],
      Site = .y$Site[1],
      estimate = slope_info$estimate,
      p.value = slope_info$p.value
    )
  }) %>%
  bind_rows()

lmer_stats <- lmer_stats %>%
  mutate(label = paste0("β = ", round(estimate, 2), 
                        ", p = ", signif(p.value, 2))) %>% 
  mutate(significance= case_when(p.value<=0.001~"***", p.value<=0.01~"**",  p.value>=0.05~ "ns", p.value<0.05~"*"))

shared_asvs_comb %>% 
  ggplot(aes(x = Site, y = SharedProp*100, fill=data_set_type)) +
  geom_boxplot(alpha=0.6) +
  labs(y = "Proportion (%) of shared ASVs (by relative abundance)", x = "", fill= "Data set")+
  facet_grid(~comparison, scales = "free_x")+
  #scale_y_log10(breaks = c(0.1, 1, 10, 50, 100))+
  theme_minimal()+
  theme(legend.position = "bottom", strip.text = element_text(face = "bold"))+
  scale_fill_manual(values = c("#31A1B3", "#765085"))+
  # Add stats labels
  geom_text(
    data = lmer_stats,
    aes(x = Site, y = 80, label = significance),
    inherit.aes = FALSE,
    size = 5
  )

ggsave("figures/shared_proportion_asvs.pdf", height = 4, width = 8)

summary(lmerTest::lmer(
    SharedProp ~ data_set_type + (1 | id.x),
    data = shared_asvs_comb %>%
      filter(comparison == "Sputum-Throat", Site == "Sputum")))
summary(lmerTest::lmer(
    SharedProp ~ data_set_type + (1 | id.x),
    data = shared_asvs_comb %>%
      filter(comparison == "Sputum-Throat", Site == "Throat")))

summary(lmerTest::lmer(
    SharedProp ~ data_set_type + (1 | id.x),
    data = shared_asvs_comb %>%
      filter(comparison == "Sputum-Stool", Site == "Sputum")))
summary(lmerTest::lmer(
    SharedProp ~ data_set_type + (1 | id.x),
    data = shared_asvs_comb %>%
      filter(comparison == "Sputum-Stool", Site == "Stool")))

summary(lmerTest::lmer(
    SharedProp ~ data_set_type + (1 | id.x),
    data = shared_asvs_comb %>%
      filter(comparison == "Stool-Throat", Site == "Throat")))
summary(lmerTest::lmer(
    SharedProp ~ data_set_type + (1 | id.x),
    data = shared_asvs_comb %>%
      filter(comparison == "Stool-Throat", Site == "Stool")))
```

```{r}
shared_long_counts$data_set_type <- "paired"

a <- shared_long_counts %>% 
  select(comparison, SharedProp, Site, data_set_type, id.x)

b <- shared_long_counts_unpar %>% 
  select(comparison, SharedProp, Site, data_set_type, id.x)

shared_asvs_comb_counts <-  rbind(a,b)

lmer_stats <- shared_asvs_comb_counts %>%
  group_by(comparison, Site) %>%
  group_map(~ {
    model <- lmerTest::lmer(SharedProp ~ data_set_type + (1 | id.x), data = .x)
    slope_info <- broom.mixed::tidy(model) %>%
      filter(term == "data_set_typeunpaired, different time point")
    tibble(
      comparison = .y$comparison[1],
      Site = .y$Site[1],
      estimate = slope_info$estimate,
      p.value = slope_info$p.value
    )
  }) %>%
  bind_rows()

lmer_stats <- lmer_stats %>%
  mutate(label = paste0("β = ", round(estimate, 2), 
                        ", p = ", signif(p.value, 2))) %>% 
  mutate(significance= case_when(p.value<=0.001~"***", p.value<=0.01~"**",  p.value>=0.05~ "ns", p.value<0.05~"*"))

shared_asvs_comb_counts$comparison <- factor(
  shared_asvs_comb_counts$comparison,
  levels = c("Sputum-Throat", "Sputum-Stool", "Stool-Throat"),
  ordered = TRUE
)

shared_asvs_comb_counts$Site <- factor(
  shared_asvs_comb_counts$Site,
  levels = c("Sputum", "Throat", "Stool"),
  ordered = TRUE
)

shared_asvs_comb_counts <- droplevels(shared_asvs_comb_counts)

p16 <- shared_asvs_comb_counts %>% 
  ggplot(aes(x = Site, y = SharedProp*100, fill=data_set_type)) +
  geom_boxplot(alpha=0.6) +
  labs(y = "Proportion of shared ASVs (%)", x = "", fill= "Data set")+
  facet_grid(~comparison, scales = "free")+
  #scale_y_log10(breaks = c(0.1, 1, 10, 50, 100))+
  theme_minimal(base_size = 14)+
  theme(legend.position = "bottom", strip.text = element_text(face = "bold"))+
  scale_fill_manual(values = c("#31A1B3", "#765085"))+
  # Add stats labels
  geom_text(
    data = lmer_stats,
    aes(x = Site, y = 80, label = significance),
    inherit.aes = FALSE,
    size = 5
  )

p16

ggsave("figures/shared_proportion_asvs_counts.pdf", height = 4, width = 8)

saveRDS(p16, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/shared_proportion_asvs_counts.rds")
```

# heatmap for shared ASVs and their relative abundances
## Sputum-Stool
```{r}
shared_asvs_spu_st_paired <- shared_long_counts %>% 
  filter(comparison=="Sputum-Stool"&data_set_type=="paired") #

# Unlist all shared ASVs into a long-format data frame
shared_asv_long_spu_st <- shared_asvs_spu_st_paired  %>%
  select(sample1, sample2, site1, site2, shared_asvs) %>%
  tidyr::unnest(shared_asvs)

shared_asv_counts_spu_st <- shared_asv_long_spu_st %>%
  group_by(shared_asvs) %>%
  summarise(n_pairs = n(), .groups = "drop") %>%
  arrange(desc(n_pairs)) %>%
  rename(ASV = shared_asvs)

asvs_shared_15plus_spu_st <- shared_asv_counts_spu_st%>%
  filter(n_pairs >= 14) %>%
  pull(ASV) %>%
  as.character()

# Subset phyloseq object to these ASVs
ps_shared_15plus_spu_st <- prune_taxa(asvs_shared_15plus_spu_st, ps_Sputum_Stool_full_unique_2_relab)

heatmap_spu_st <- psmelt(ps_shared_15plus_spu_st)

hm2 <- heatmap_spu_st %>% 
  mutate(asv_Genus=paste0(Genus, " (",OTU, ")")) %>% 
ggplot(aes(x = x_sample_id, y = asv_Genus, fill = log10(Abundance*100))) +
  geom_tile() +
  scale_fill_gradient(
  low = "white",
  high = "#31A1B3",
  name = "Rel. abundance (%)",
  breaks = log10(c(0.01, 0.1, 1, 10, 100)),
  labels = c("0.01%", "0.1%", "1%", "10%", "100%")
)+
  facet_grid(~ material, scales = "free_x", space = "free_x") +
  theme_minimal(base_size = 14) +
  theme(title = element_text(size = 14),
    axis.text.y = element_text(face = "italic"),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  ) +
  labs(#title = "Sputum-Stool",
    x = "Samples (N pairs = 51)",
    y = ""
  )
hm2
```

## Sputum-Throat
```{r}
shared_asvs_spu_thr_paired <- shared_long_counts %>% 
  filter(comparison=="Sputum-Throat"&data_set_type=="paired") #

# Unlist all shared ASVs into a long-format data frame
shared_asv_long_spu_thr <- shared_asvs_spu_thr_paired  %>%
  select(sample1, sample2, site1, site2, shared_asvs) %>%
  tidyr::unnest(shared_asvs)

shared_asv_counts_spu_thr <- shared_asv_long_spu_thr %>%
  group_by(shared_asvs) %>%
  summarise(n_pairs = n(), .groups = "drop") %>%
  arrange(desc(n_pairs)) %>%
  rename(ASV = shared_asvs)

asvs_shared_15plus_spu_thr<- shared_asv_counts_spu_thr%>%
  filter(n_pairs >= 58) %>%
  pull(ASV) %>%
  as.character()

# Subset phyloseq object to these ASVs
ps_shared_15plus_spu_thr <- prune_taxa(asvs_shared_15plus_spu_thr, ps_sputum_throat_full_unique_2_relab)

heatmap_spu_thr <- psmelt(ps_shared_15plus_spu_thr)

hm1 <- heatmap_spu_thr %>% 
  mutate(asv_Genus=paste0(Genus, " (",OTU, ")")) %>% 
ggplot(aes(x = x_sample_id, y = asv_Genus, fill = log10(Abundance*100))) +
  geom_tile() +
  scale_fill_gradient(
  low = "white",
  high = "#31A1B3",
  name = "Rel. abundance (%)",
  breaks = log10(c(0.01, 0.1, 1, 10, 100)),
  labels = c("0.01%", "0.1%", "1%", "10%", "100%")
)+
  facet_grid(~ material, scales = "free_x", space = "free_x") +
  theme_minimal(base_size = 14) +
  theme(title = element_text(size = 14),
    axis.text.y = element_text(face = "italic"),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  ) +
  labs(
    x = "Samples (N pairs = 45)",
    y = "Top 20 shared ASVs"#,
    #title="Sputum-Throat"
  )
hm1
```

## Throat-Stool
```{r}
shared_asvs_thr_st_paired <- shared_long_counts %>% 
  filter(comparison=="Stool-Throat"&data_set_type=="paired") #

# Unlist all shared ASVs into a long-format data frame
shared_asv_long_thr_st <- shared_asvs_thr_st_paired %>%
  select(sample1, sample2, site1, site2, shared_asvs) %>%
  tidyr::unnest(shared_asvs)

shared_asv_counts_thr_st <- shared_asv_long_thr_st %>%
  group_by(shared_asvs) %>%
  summarise(n_pairs = n(), .groups = "drop") %>%
  arrange(desc(n_pairs)) %>%
  rename(ASV = shared_asvs)

asvs_shared_15plus_thr_st<- shared_asv_counts_thr_st%>%
  filter(n_pairs >= 38) %>%
  pull(ASV) %>%
  as.character()

# Subset phyloseq object to these ASVs
ps_shared_15plus_thr_st <- prune_taxa(asvs_shared_15plus_thr_st, ps_full_fil_relab)

shared_asv_long_thr_st_pairs <- shared_asvs_thr_st_paired %>%
  select(sample1, sample2, site1, site2, pairs) %>%
  tidyr::unnest(pairs)

ps_shared_15plus_thr_st <- subset_samples( ps_shared_15plus_thr_st,x_sample_id%in%shared_asv_long_thr_st_pairs$pairs)

heatmap_thr_st <- psmelt(ps_shared_15plus_thr_st)

hm3 <- heatmap_thr_st %>% 
  filter(OTU!="ASV62") %>% 
  mutate(asv_Genus=paste0(Genus, " (",OTU, ")")) %>% 
ggplot(aes(x = x_sample_id, y = asv_Genus, fill = log10(Abundance*100))) +
  geom_tile() +
  scale_fill_gradient(
  low = "white",
  high = "#31A1B3",
  name = "Rel. abundance (%)",
  breaks = log10(c(0.01, 0.1, 1, 10, 100)),
  labels = c("0.01%", "0.1%", "1%", "10%", "100%")
) +
  facet_grid(~ material, scales = "free_x", space = "free_x") +
  theme_minimal(base_size = 14) +
  theme(title = element_text( size = 14),
    axis.text.y = element_text(face = "italic"),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.grid = element_blank()
  ) +
  labs(#title="Stool-Throat",
    x = "Samples (N pairs = 181)",
    y = ""
  )

hm3
```
## combine into one heatmap plot
```{r, fig.width=16, fig.height=6}
hm_comb <- ggarrange(hm1, hm2, hm3, common.legend = T, nrow = 1, legend = "bottom")

saveRDS(hm_comb, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/shared_asvs_heatmap.rds")
```

# PCoA on sample type
```{r}
PCA_all <- plot_ordination(ps_full_fil_relab, ordinate(ps_full_fil_relab, "MDS"), color = "material")

xlabels <- c("Sputum","Throat","Stool")

p1 <- PCA_all +
  geom_point(size = 4, alpha = 0.7) +
  scale_color_manual(values=c("#CCB22BFF",  "#6FB899FF","#A68A7BFF"),labels = xlabels) +
  #scale_fill_manual(values=c("#CCB22BFF",  "#6FB899FF","#A68A7BFF"),labels = xlabels) +
  theme_classic(base_size = 14) +
  theme(text = element_text(size = 18), legend.position = "bottom", legend.text = element_text(size = 16), legend.title = element_blank()) +
  guides(color = guide_legend(title = "Sample type", title.position = "left", nrow = 1))+
  stat_ellipse()
p1
saveRDS(p1, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/pcoa_all_cf.rds")
```

# Simple PERMANOVA on paired and unpaired data sets
```{r}
# List of variables to test individually
terms_to_test <- c("material", "visit_cal_9", "id.x")

# Function to run single-term PERMANOVA
run_single_term_permanova <- function(term, distance_matrix, metadata, dataset_label) {
  formula_str <- as.formula(paste("distance_matrix ~", term))
  result <- vegan::adonis2(formula_str, data = metadata, permutations = 999, strata = metadata$id.x)
  
  result_tbl <- as_tibble(result, rownames = "term") %>%
    filter(term == term) %>%
    mutate(
      data_set = dataset_label,
      formula = paste("BC_dist ~", term),
      N = nrow(metadata),
      term = term  # Correct the overwritten 'model' name
    )
  return(result_tbl)
}

## All samples

set.seed(100)
BC_dist <- phyloseq::distance(ps_full_fil_relab, method = "bray", weighted = FALSE)
metadata <- as(sample_data(ps_full_fil_relab), "data.frame")
res_all <- lapply(terms_to_test, function(term) {
  run_single_term_permanova(term, BC_dist, metadata, "All")
})
res_all <- bind_rows(res_all)
res_all<- res_all %>% 
  filter(term=="Model") %>% 
  mutate(term = case_when(
    Df == 2 ~ "Sample type",
    Df == 8 ~ "Sample time point",
    Df == 34 ~ "ID"))

# single sample types
terms_to_test_single <- c("visit_cal_9", "id.x")

## Sputum
set.seed(100)
ps_relab_spu<- subset_samples(ps_full_fil_relab, material=="Sputum")
BC_dist <- phyloseq::distance(ps_relab_spu, method = "bray", weighted = FALSE)
metadata <- as(sample_data(ps_relab_spu), "data.frame")
res_spu_list <- lapply(terms_to_test_single, function(term) {
  run_single_term_permanova(term, BC_dist, metadata, "Sputum")
})
res_spu<- bind_rows(res_spu_list)
res_spu<- res_spu %>% 
  filter(term=="Model") %>% 
  mutate(term = case_when(
    Df == 1 ~ "Sample type",
    Df == 8 ~ "Sample time point",
    Df == 18 ~ "ID"))

## Throat
set.seed(100)
set.seed(100)
ps_relab_thr<- subset_samples(ps_full_fil_relab, material=="Throat")
BC_dist <- phyloseq::distance(ps_relab_thr, method = "bray", weighted = FALSE)
metadata <- as(sample_data(ps_relab_thr), "data.frame")
res_thr_list <- lapply(terms_to_test_single, function(term) {
  run_single_term_permanova(term, BC_dist, metadata, "Throat")
})
res_thr <- bind_rows(res_thr_list)
res_thr <- res_thr %>% 
  filter(term=="Model") %>% 
  mutate(term = case_when(
    Df == 1 ~ "Sample type",
    Df == 8 ~ "Sample time point",
    Df == 34 ~ "ID"))

## Stool
set.seed(100)
set.seed(100)
ps_relab_st<- subset_samples(ps_full_fil_relab, material=="Stool")
BC_dist <- phyloseq::distance(ps_relab_st, method = "bray", weighted = FALSE)
metadata <- as(sample_data(ps_relab_st), "data.frame")
res_st_list <- lapply(terms_to_test_single, function(term) {
  run_single_term_permanova(term, BC_dist, metadata, "Stool")
})
res_st <- bind_rows(res_st_list)
res_st <- res_st %>% 
  filter(term=="Model") %>% 
  mutate(term = case_when(
    Df == 1 ~ "Sample type",
    Df == 8 ~ "Sample time point",
    Df == 34 ~ "ID"))

# Apply to each paired dataset
## Sputum-throat
set.seed(100)
BC_dist <- phyloseq::distance(ps_sputum_throat_full_unique_2_relab, method = "bray", weighted = FALSE)
metadata <- as(sample_data(ps_sputum_throat_full_unique_2_relab), "data.frame")
res_spu_thr_p_list <- lapply(terms_to_test, function(term) {
  run_single_term_permanova(term, BC_dist, metadata, "paired Sputum-Throat")
})
res_spu_thr_p <- bind_rows(res_spu_thr_p_list)
res_spu_thr_p <- res_spu_thr_p %>% 
  filter(term=="Model") %>% 
  mutate(term = case_when(
    Df == 1 ~ "Sample type",
    Df == 8 ~ "Sample time point",
    Df == 14 ~ "ID"))

# For Sputum-Stool
set.seed(100)
BC_dist <- phyloseq::distance(ps_Sputum_Stool_full_unique_2_relab, method = "bray", weighted = FALSE)
metadata <- as(sample_data(ps_Sputum_Stool_full_unique_2_relab), "data.frame")

res_spu_st_p_list <- lapply(terms_to_test, function(term) {
  run_single_term_permanova(term, BC_dist, metadata, "paired Sputum-Stool")
})
res_spu_st_p <- bind_rows(res_spu_st_p_list)

res_spu_st_p <- res_spu_st_p %>% 
  filter(term=="Model") %>% 
  mutate(term = case_when(
    Df == 1 ~ "Sample type",
    Df == 8 ~ "Sample time point",
    Df == 17 ~ "ID"))

# For Stool-Throat
ps_st_thr_paired <- subset_samples(ps_full_fil_relab, x_sample_id %in% shared_asv_long_thr_st_pairs$pairs)
set.seed(100)
BC_dist <- phyloseq::distance(ps_st_thr_paired, method = "bray", weighted = FALSE)
metadata <- as(sample_data(ps_st_thr_paired), "data.frame")

res_st_thr_p_list <- lapply(terms_to_test, function(term) {
  run_single_term_permanova(term, BC_dist, metadata, "paired Stool-Throat")
})
res_st_thr_p <- bind_rows(res_st_thr_p_list)

res_st_thr_p <- res_st_thr_p %>% 
  filter(term=="Model") %>% 
  mutate(term = case_when(
    Df == 1 ~ "Sample type",
    Df == 8 ~ "Sample time point",
    Df == 34 ~ "ID"))

# Combine all results
res_comb_p <- rbind(res_all, res_spu, res_thr, res_st, res_spu_thr_p, res_spu_st_p, res_st_thr_p)

# Add significance
res_comb_p <- res_comb_p %>% mutate(Significance = case_when(
  `Pr(>F)` <= 0.001 ~ "≤ 0.001",
  `Pr(>F)` <= 0.01 ~ "≤ 0.01",
  `Pr(>F)` <= 0.05 ~ "≤ 0.05",
  TRUE ~ "ns"
))

# Set factor levels
res_comb_p$data_set <- factor(res_comb_p$data_set,
                              levels = c("All", "paired Sputum-Throat", "paired Sputum-Stool", "paired Stool-Throat",
                                         "Sputum", "Throat", "Stool"))

res_comb_p <- res_comb_p %>% 
  mutate(ylab = paste(data_set, N, sep = ", N=")) %>%
  mutate(ylab = factor(ylab, levels = unique(ylab[order(data_set)])))

# Plot
custom_labels = c("Time point","Sample type")
p2 <- res_comb_p %>% 
  filter(term!="ID") %>% 
  ggplot(aes(y = term, x = ylab)) +
  geom_point(aes(fill = Significance, size = R2 * 100), shape = 21, color = "black") +
  scale_fill_manual(values = c("≤ 0.001" = "#765085", "≤ 0.01" = "#31A1B3FF", "≤ 0.05" = "#B9A8D0", "ns" = "grey")) +
  scale_size_continuous(range = c(3, 15)) +
  theme_minimal(base_size = 14) +
  scale_y_discrete(labels = custom_labels) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.text.y = element_text(size = 16),
        legend.title.position = "top",
        axis.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16)) +
  labs(fill = "p value", size = "Explained variance (%)") +
  ylab("") +
  xlab("") +
  guides(fill = guide_legend(override.aes = list(size = 4)), fill = "none")

p2


saveRDS(p2, "/Users/rebecca/Documents/Forschung/IMMProveCF/R_analysis/rds_files/permanova_all_cf.rds")
```

```{r, fig.width=12, fig.height=4}
ggarrange(p5,p6, nrow = 1)
ggsave("figures/combined_alpha_congruence.pdf", width = 12, height = 3)
```

```{r}
sessionInfo()
```

